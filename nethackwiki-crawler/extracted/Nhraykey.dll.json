{"title":"Nhraykey.dll","url":"https://nethackwiki.com/wiki/Nhraykey.dll","type":"markdown","data":"**Nhraykey.dll** is a keyboard handler for the [Microsoft Windows](/wiki/Microsoft_Windows \"Microsoft Windows\") text-mode version of [NetHack 3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\"). Its purpose is to improve handling of keyboards with non-USA layouts.\n\nThis is a separate DLL in NetHack 3.4.2 through 3.6.6. In the current development version, it is merged into the main binary, along with its alternatives, nhdefkey.dll and nh340key.dll.\n\n[ ]\n\n## Contents\n\n- [1 How it works](#How_it_works)\n- [2 Bug W343-4](#Bug_W343-4)\n- [3 Further reading](#Further_reading)\n- [4 References](#References)\n\n## How it works\n\nNetHack wants both keyboard and mouse input, but the Win32 console APIs provide no easy way of getting mouse input and also translating keystrokes according to the user's locale. The ReadConsole API retrieves keystrokes and translates them properly, but discards mouse events. The ReadConsoleInput API retrieves key and mouse events but does not translate the keys.\n\n[NetHack 3.4.1](/wiki/NetHack_3.4.1 \"NetHack 3.4.1\") attempted to solve this problem by reading all input with ReadConsoleInput and passing it to the ToAscii API. The default keyboard handler, [nhdefkey.dll](/index.php?title=Nhdefkey.dll\\&action=edit\\&redlink=1 \"Nhdefkey.dll (page does not exist)\"), still works this way. This approach, however, only seems to work with USA keyboards. With others, it ends up using the USA layout, and the user is likely to find this confusing.\n\nNhraykey.dll takes a different approach. First, it notes that commands have different needs from prompts:\n\n- When NetHack is waiting for a command, such as (d)rop or one of the hjklyubn keys, it wants any of three kinds of input: an [ASCII](/wiki/ASCII \"ASCII\") character, a character with the eighth bit set to indicate an Alt sequence, or a mouse event. We do not want to send a non-ASCII character except in response to an Alt sequence, else the game might give surprising behavior, even accidentally invoking the #[quit](/wiki/Quit \"Quit\") command.\n- When NetHack has prompted for text, the mouse is unimportant, and we don't want Alt sequences; but we do want any character that the user can type, ASCII or not.\n\nSo it separates these two functions, which had previously been one, and solves the problem according to the needs of each mode. For a command, it first uses PeekConsoleInput to determine what type of input is available. For a key event, it goes to ReadConsole to retrieve the key properly translated. For a mouse event, it goes to ReadConsoleInput to fetch the event.\n\nThe idea is never to call ReadConsole when a mouse event is important, unless we can be sure that it will not block; if that happened, the mouse would cease to function until it returned. ReadConsole is prevented from blocking by pushing a bogus key event on the queue; if there's nothing else for ReadConsole to fetch, it will fetch the bogus key. The bogus key is constructed so that it does not match any real key event, and can be filtered out.\n\nFor prompts, ReadConsole is used directly, because mouse events are not needed.\n\n## Bug W343-4\n\n- *Main article: [W343-4](/wiki/W343-4 \"W343-4\")*\n\nThere is one point at which the unmodified nhraykey.dll needs to filter the bogus key, but fails to do so. This can result in ReadConsole being called and blocking because there is no real key for it to read. A [patch](/wiki/Patch \"Patch\") is available to fix this bug in 3.4.3, and it is fixed in 3.6.1.[\\[1\\]](#cite_note-1)\n\n## Further reading\n\n[The patch](http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/76c79f23e56a210f) against [NetHack 3.4.1](/wiki/NetHack_3.4.1 \"NetHack 3.4.1\") that became nhraykey.dll.\n\n[Description](http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/5218c0df964795f7) of the patch.\n\n[Fix](http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/e92013db64618fe3) for bug W343-4.\n\n## References\n\n1. [↑](#cite_ref-1) [DevTeam GitHub repository, commit 7885796.](https://github.com/NetHack/NetHack/commit/78857961d2b40f01516ec3ecdafd348c79142bbc#diff-fa02d0cc210b095a04eaed9c7fbbd331)\n\n[![This article has been updated to reflect NetHack 3.6.1. Click here for more information.](/images/d/d3/Nh361-icon.png)](/wiki/NetHackWiki:Next_version \"This article has been updated to reflect NetHack 3.6.1. Click here for more information.\")\n\n**This page may need to be updated for the [current version](/wiki/Current_version \"Current version\") of *NetHack*.**\n\nIt may contain text specific to [NetHack 3.6.1](/wiki/NetHack_3.6.1 \"NetHack 3.6.1\"). Information on this page may be out of date.\n\n**Editors:** After reviewing this page and making necessary edits, please change the {{nethack-361}} tag to the current version's tag or {{noversion}} as appropriate.\n","html":"<!DOCTYPE html>\n<html class=\"client-nojs\" lang=\"en\" dir=\"ltr\">\n<head>\n<meta charset=\"UTF-8\"/>\n<title>Nhraykey.dll - NetHack Wiki</title>\n<script>document.documentElement.className = document.documentElement.className.replace( /(^|\\s)client-nojs(\\s|$)/, \"$1client-js$2\" );</script>\n<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({\"wgCanonicalNamespace\":\"\",\"wgCanonicalSpecialPageName\":false,\"wgNamespaceNumber\":0,\"wgPageName\":\"Nhraykey.dll\",\"wgTitle\":\"Nhraykey.dll\",\"wgCurRevisionId\":146101,\"wgRevisionId\":146101,\"wgArticleId\":4352,\"wgIsArticle\":true,\"wgIsRedirect\":false,\"wgAction\":\"view\",\"wgUserName\":null,\"wgUserGroups\":[\"*\"],\"wgCategories\":[\"Annotations\",\"Nethack-361 articles\"],\"wgBreakFrames\":false,\"wgPageContentLanguage\":\"en\",\"wgPageContentModel\":\"wikitext\",\"wgSeparatorTransformTable\":[\"\",\"\"],\"wgDigitTransformTable\":[\"\",\"\"],\"wgDefaultDateFormat\":\"dmy\",\"wgMonthNames\":[\"\",\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"wgMonthNamesShort\":[\"\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"wgRelevantPageName\":\"Nhraykey.dll\",\"wgRelevantArticleId\":4352,\"wgRequestId\":\"20b5821783e21a878bff6f98\",\"wgCSPNonce\":false,\"wgIsProbablyEditable\":false,\"wgRelevantPageIsProbablyEditable\":false,\"wgRestrictionEdit\":[],\"wgRestrictionMove\":[],\"wgWikiEditorEnabledModules\":[],\"wgCategoryTreePageCategoryOptions\":\"{\\\"mode\\\":0,\\\"hideprefix\\\":20,\\\"showcount\\\":true,\\\"namespaces\\\":false}\"});mw.loader.state({\"site.styles\":\"ready\",\"noscript\":\"ready\",\"user.styles\":\"ready\",\"user\":\"ready\",\"user.options\":\"ready\",\"user.tokens\":\"loading\",\"ext.cite.styles\":\"ready\",\"mediawiki.legacy.shared\":\"ready\",\"mediawiki.legacy.commonPrint\":\"ready\",\"mediawiki.toc.styles\":\"ready\",\"mediawiki.skinning.interface\":\"ready\",\"skins.vector.styles\":\"ready\"});mw.loader.implement(\"user.tokens@0tffind\",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({\"editToken\":\"+\\\\\",\"patrolToken\":\"+\\\\\",\"watchToken\":\"+\\\\\",\"csrfToken\":\"+\\\\\"});\n});RLPAGEMODULES=[\"ext.cite.a11y\",\"site\",\"mediawiki.page.startup\",\"mediawiki.user\",\"mediawiki.page.ready\",\"mediawiki.toc\",\"mediawiki.searchSuggest\",\"skins.vector.js\"];mw.loader.load(RLPAGEMODULES);});</script>\n<link rel=\"stylesheet\" href=\"/load.php?debug=false&amp;lang=en&amp;modules=ext.cite.styles%7Cmediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.skinning.interface%7Cmediawiki.toc.styles%7Cskins.vector.styles&amp;only=styles&amp;skin=vector\"/>\n<script async=\"\" src=\"/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector\"></script>\n<meta name=\"ResourceLoaderDynamicStyles\" content=\"\"/>\n<link rel=\"stylesheet\" href=\"/load.php?debug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector\"/>\n<meta name=\"generator\" content=\"MediaWiki 1.32.5\"/>\n<meta name=\"description\" content=\"NetHack wants both keyboard and mouse input, but the Win32 console APIs provide no easy way of getting mouse input and also translating keystrokes according to the user&#039;s locale.  The ReadConsole API retrieves keystrokes and translates them properly, but discards mouse events.  The ReadConsoleInput API retrieves key and mouse events but does not translate the keys.\"/>\n<link rel=\"image_src\" href=\"/images/6/65/Nethackwiki-logo.png\"/>\n<link rel=\"shortcut icon\" href=\"/images/6/64/Favicon.ico\"/>\n<link rel=\"search\" type=\"application/opensearchdescription+xml\" href=\"/opensearch_desc.php\" title=\"NetHackWiki\"/>\n<link rel=\"EditURI\" type=\"application/rsd+xml\" href=\"https://nethackwiki.com/api.php?action=rsd\"/>\n<link rel=\"canonical\" href=\"/wiki/Nhraykey.dll\"/>\n<!--[if lt IE 9]><script src=\"/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=vector&amp;sync=1\"></script><![endif]-->\n</head>\n<body class=\"mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-Nhraykey_dll rootpage-Nhraykey_dll skin-vector action-view\">\t\t<div id=\"mw-page-base\" class=\"noprint\"></div>\n\t\t<div id=\"mw-head-base\" class=\"noprint\"></div>\n\t\t<div id=\"content\" class=\"mw-body\" role=\"main\">\n\t\t\t<a id=\"top\"></a>\n\t\t\t<div class=\"mw-indicators mw-body-content\">\n</div>\n<h1 id=\"firstHeading\" class=\"firstHeading\" lang=\"en\">Nhraykey.dll</h1>\t\t\t<div id=\"bodyContent\" class=\"mw-body-content\">\n\t\t\t\t<div id=\"siteSub\" class=\"noprint\">From NetHackWiki</div>\t\t\t\t<div id=\"contentSub\"></div>\n\t\t\t\t<div id=\"jump-to-nav\"></div>\t\t\t\t<a class=\"mw-jump-link\" href=\"#mw-head\">Jump to navigation</a>\n\t\t\t\t<a class=\"mw-jump-link\" href=\"#p-search\">Jump to search</a>\n\t\t\t\t<div id=\"mw-content-text\" lang=\"en\" dir=\"ltr\" class=\"mw-content-ltr\"><div class=\"mw-parser-output\"><p><b>Nhraykey.dll</b> is a keyboard handler for the <a href=\"/wiki/Microsoft_Windows\" title=\"Microsoft Windows\">Microsoft Windows</a> text-mode version of <a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">NetHack 3.4.3</a>.  Its purpose is to improve handling of keyboards with non-USA layouts.\n</p><p>This is a separate DLL in NetHack 3.4.2 through 3.6.6. In the current development version, it is merged into the main binary, along with its alternatives, nhdefkey.dll and nh340key.dll.\n</p>\n<div id=\"toc\" class=\"toc\"><input type=\"checkbox\" role=\"button\" id=\"toctogglecheckbox\" class=\"toctogglecheckbox\" style=\"display:none\" /><div class=\"toctitle\" lang=\"en\" dir=\"ltr\"><h2>Contents</h2><span class=\"toctogglespan\"><label class=\"toctogglelabel\" for=\"toctogglecheckbox\"></label></span></div>\n<ul>\n<li class=\"toclevel-1 tocsection-1\"><a href=\"#How_it_works\"><span class=\"tocnumber\">1</span> <span class=\"toctext\">How it works</span></a></li>\n<li class=\"toclevel-1 tocsection-2\"><a href=\"#Bug_W343-4\"><span class=\"tocnumber\">2</span> <span class=\"toctext\">Bug W343-4</span></a></li>\n<li class=\"toclevel-1 tocsection-3\"><a href=\"#Further_reading\"><span class=\"tocnumber\">3</span> <span class=\"toctext\">Further reading</span></a></li>\n<li class=\"toclevel-1 tocsection-4\"><a href=\"#References\"><span class=\"tocnumber\">4</span> <span class=\"toctext\">References</span></a></li>\n</ul>\n</div>\n\n<h2><span class=\"mw-headline\" id=\"How_it_works\">How it works</span></h2>\n<p>NetHack wants both keyboard and mouse input, but the Win32 console APIs provide no easy way of getting mouse input and also translating keystrokes according to the user's locale.  The ReadConsole API retrieves keystrokes and translates them properly, but discards mouse events.  The ReadConsoleInput API retrieves key and mouse events but does not translate the keys.\n</p><p><a href=\"/wiki/NetHack_3.4.1\" title=\"NetHack 3.4.1\">NetHack 3.4.1</a> attempted to solve this problem by reading all input with ReadConsoleInput and passing it to the ToAscii API.  The default keyboard handler, <a href=\"/index.php?title=Nhdefkey.dll&amp;action=edit&amp;redlink=1\" class=\"new\" title=\"Nhdefkey.dll (page does not exist)\">nhdefkey.dll</a>, still works this way.  This approach, however, only seems to work with USA keyboards.  With others, it ends up using the USA layout, and the user is likely to find this confusing.\n</p><p>Nhraykey.dll takes a different approach.  First, it notes that commands have different needs from prompts:\n</p>\n<ul><li>When NetHack is waiting for a command, such as (d)rop or one of the hjklyubn keys, it wants any of three kinds of input:  an <a href=\"/wiki/ASCII\" class=\"mw-redirect\" title=\"ASCII\">ASCII</a> character, a character with the eighth bit set to indicate an Alt sequence, or a mouse event.  We do not want to send a non-ASCII character except in response to an Alt sequence, else the game might give surprising behavior, even accidentally invoking the #<a href=\"/wiki/Quit\" title=\"Quit\">quit</a> command.</li>\n<li>When NetHack has prompted for text, the mouse is unimportant, and we don't want Alt sequences; but we do want any character that the user can type, ASCII or not.</li></ul>\n<p>So it separates these two functions, which had previously been one, and solves the problem according to the needs of each mode.  For a command, it first uses PeekConsoleInput to determine what type of input is available.  For a key event, it goes to ReadConsole to retrieve the key properly translated.  For a mouse event, it goes to ReadConsoleInput to fetch the event.\n</p><p>The idea is never to call ReadConsole when a mouse event is important, unless we can be sure that it will not block; if that happened, the mouse would cease to function until it returned.  ReadConsole is prevented from blocking by pushing a bogus key event on the queue; if there's nothing else for ReadConsole to fetch, it will fetch the bogus key.  The bogus key is constructed so that it does not match any real key event, and can be filtered out.\n</p><p>For prompts, ReadConsole is used directly, because mouse events are not needed.\n</p>\n<h2><span class=\"mw-headline\" id=\"Bug_W343-4\">Bug W343-4</span></h2>\n<dl><dd><div class=\"noprint relarticle mainarticle\"><i>Main article: <a href=\"/wiki/W343-4\" title=\"W343-4\">W343-4</a></i></div></dd></dl>\n<p>There is one point at which the unmodified nhraykey.dll needs to filter the bogus key, but fails to do so.  This can result in ReadConsole being called and blocking because there is no real key for it to read.  A <a href=\"/wiki/Patch\" title=\"Patch\">patch</a> is available to fix this bug in 3.4.3, and it is fixed in 3.6.1.<sup id=\"cite_ref-1\" class=\"reference\"><a href=\"#cite_note-1\">&#91;1&#93;</a></sup>\n</p>\n<h2><span class=\"mw-headline\" id=\"Further_reading\">Further reading</span></h2>\n<p><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/76c79f23e56a210f\">The patch</a> against <a href=\"/wiki/NetHack_3.4.1\" title=\"NetHack 3.4.1\">NetHack 3.4.1</a> that became nhraykey.dll.\n</p><p><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/5218c0df964795f7\">Description</a> of the patch.\n</p><p><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/e92013db64618fe3\">Fix</a> for bug W343-4.\n</p>\n<h2><span class=\"mw-headline\" id=\"References\">References</span></h2>\n<div class=\"mw-references-wrap\"><ol class=\"references\">\n<li id=\"cite_note-1\"><span class=\"mw-cite-backlink\"><a href=\"#cite_ref-1\">↑</a></span> <span class=\"reference-text\"><a class=\"external text\" href=\"https://github.com/NetHack/NetHack/commit/78857961d2b40f01516ec3ecdafd348c79142bbc#diff-fa02d0cc210b095a04eaed9c7fbbd331\">DevTeam GitHub repository, commit 7885796.</a></span>\n</li>\n</ol></div>\n<div style=\"display:none; right:10px; padding-bottom: 17px\" class=\"metadata topicon nopopups\"><div style=\"margin-top: -10px\"><a href=\"/wiki/NetHackWiki:Next_version\" title=\"This article has been updated to reflect NetHack 3.6.1. Click here for more information.\"><img alt=\"This article has been updated to reflect NetHack 3.6.1. Click here for more information.\" src=\"/images/d/d3/Nh361-icon.png\" width=\"32\" height=\"32\" /></a></div></div>\n<div class=\"todo\">\n<p><b>This page may need to be updated for the <a href=\"/wiki/Current_version\" class=\"mw-redirect\" title=\"Current version\">current version</a> of <i>NetHack</i>.</b>\n</p><p>It may contain text specific to <a href=\"/wiki/NetHack_3.6.1\" title=\"NetHack 3.6.1\">NetHack 3.6.1</a>. Information on this page may be out of date.\n</p><p><b>Editors:</b> After reviewing this page and making necessary edits, please change the {{nethack-361}} tag to the current version's tag or {{noversion}} as appropriate.\n</p>\n</div>\n\n<!-- \nNewPP limit report\nCached time: 20240926185420\nCache expiry: 604800\nDynamic content: false\nCPU time usage: 0.016 seconds\nReal time usage: 0.049 seconds\nPreprocessor visited node count: 142/1000000\nPreprocessor generated node count: 1091/1000000\nPost‐expand include size: 1730/2097152 bytes\nTemplate argument size: 262/2097152 bytes\nHighest expansion depth: 8/40\nExpensive parser function count: 0/100\nUnstrip recursion depth: 0/20\nUnstrip post‐expand size: 509/5000000 bytes\n-->\n<!--\nTransclusion expansion time report (%,ms,calls,template)\n100.00%   21.927      1 -total\n 54.12%   11.868      1 Template:Nethack-361\n 35.12%    7.700      1 Template:Version_icon\n 19.51%    4.277      1 Template:Main\n 17.59%    3.856      1 Template:Top_icon\n-->\n\n<!-- Saved in parser cache with key wikihackdb:pcache:idhash:4352-0!canonical and timestamp 20240926185420 and revision id 146101\n -->\n</div></div>\t\t\t\t\t<div class=\"printfooter\">\n\t\t\t\t\t\tRetrieved from \"<a dir=\"ltr\" href=\"https://nethackwiki.com/index.php?title=Nhraykey.dll&amp;oldid=146101\">https://nethackwiki.com/index.php?title=Nhraykey.dll&amp;oldid=146101</a>\"\t\t\t\t\t</div>\n\t\t\t\t<div id=\"catlinks\" class=\"catlinks\" data-mw=\"interface\"><div id=\"mw-normal-catlinks\" class=\"mw-normal-catlinks\"><a href=\"/wiki/Special:Categories\" title=\"Special:Categories\">Categories</a>: <ul><li><a href=\"/wiki/Category:Annotations\" title=\"Category:Annotations\">Annotations</a></li><li><a href=\"/wiki/Category:Nethack-361_articles\" title=\"Category:Nethack-361 articles\">Nethack-361 articles</a></li></ul></div></div>\t\t\t\t<div class=\"visualClear\"></div>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t<div id=\"mw-navigation\">\n\t\t\t<h2>Navigation menu</h2>\n\t\t\t<div id=\"mw-head\">\n\t\t\t\t\t\t\t\t\t<div id=\"p-personal\" role=\"navigation\" class=\"\" aria-labelledby=\"p-personal-label\">\n\t\t\t\t\t\t<h3 id=\"p-personal-label\">Personal tools</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"pt-createaccount\"><a href=\"/index.php?title=Special:CreateAccount&amp;returnto=Nhraykey.dll\" title=\"You are encouraged to create an account and log in; however, it is not mandatory\">Create account</a></li><li id=\"pt-login\"><a href=\"/index.php?title=Special:UserLogin&amp;returnto=Nhraykey.dll\" title=\"You are encouraged to log in; however, it is not mandatory [o]\" accesskey=\"o\">Log in</a></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div id=\"left-navigation\">\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-namespaces\" role=\"navigation\" class=\"vectorTabs\" aria-labelledby=\"p-namespaces-label\">\n\t\t\t\t\t\t<h3 id=\"p-namespaces-label\">Namespaces</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"ca-nstab-main\" class=\"selected\"><span><a href=\"/wiki/Nhraykey.dll\" title=\"View the content page [c]\" accesskey=\"c\">Page</a></span></li><li id=\"ca-talk\" class=\"new\"><span><a href=\"/index.php?title=Talk:Nhraykey.dll&amp;action=edit&amp;redlink=1\" rel=\"discussion\" title=\"Discussion about the content page (page does not exist) [t]\" accesskey=\"t\">Discussion</a></span></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-variants\" role=\"navigation\" class=\"vectorMenu emptyPortlet\" aria-labelledby=\"p-variants-label\">\n\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" class=\"vectorMenuCheckbox\" aria-labelledby=\"p-variants-label\" />\n\t\t\t\t\t\t<h3 id=\"p-variants-label\">\n\t\t\t\t\t\t\t<span>Variants</span>\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div class=\"menu\">\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t<div id=\"right-navigation\">\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-views\" role=\"navigation\" class=\"vectorTabs\" aria-labelledby=\"p-views-label\">\n\t\t\t\t\t\t<h3 id=\"p-views-label\">Views</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"ca-view\" class=\"collapsible selected\"><span><a href=\"/wiki/Nhraykey.dll\">Read</a></span></li><li id=\"ca-viewsource\" class=\"collapsible\"><span><a href=\"/index.php?title=Nhraykey.dll&amp;action=edit\" title=\"This page is protected.&#10;You can view its source [e]\" accesskey=\"e\">View source</a></span></li><li id=\"ca-history\" class=\"collapsible\"><span><a href=\"/index.php?title=Nhraykey.dll&amp;action=history\" title=\"Past revisions of this page [h]\" accesskey=\"h\">View history</a></span></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-cactions\" role=\"navigation\" class=\"vectorMenu emptyPortlet\" aria-labelledby=\"p-cactions-label\">\n\t\t\t\t\t\t<input type=\"checkbox\" class=\"vectorMenuCheckbox\" aria-labelledby=\"p-cactions-label\" />\n\t\t\t\t\t\t<h3 id=\"p-cactions-label\"><span>More</span></h3>\n\t\t\t\t\t\t<div class=\"menu\">\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-search\" role=\"search\">\n\t\t\t\t\t\t<h3>\n\t\t\t\t\t\t\t<label for=\"searchInput\">Search</label>\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<form action=\"/index.php\" id=\"searchform\">\n\t\t\t\t\t\t\t<div id=\"simpleSearch\">\n\t\t\t\t\t\t\t\t<input type=\"search\" name=\"search\" placeholder=\"Search NetHackWiki\" title=\"Search NetHackWiki [f]\" accesskey=\"f\" id=\"searchInput\"/><input type=\"hidden\" value=\"Special:Search\" name=\"title\"/><input type=\"submit\" name=\"fulltext\" value=\"Search\" title=\"Search the pages for this text\" id=\"mw-searchButton\" class=\"searchButton mw-fallbackSearchButton\"/><input type=\"submit\" name=\"go\" value=\"Go\" title=\"Go to a page with this exact name if it exists\" id=\"searchButton\" class=\"searchButton\"/>\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id=\"mw-panel\">\n\t\t\t\t<div id=\"p-logo\" role=\"banner\"><a class=\"mw-wiki-logo\" href=\"/wiki/Main_Page\"  title=\"Visit the main page\"></a></div>\n\t\t\t\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-navigation\" aria-labelledby=\"p-navigation-label\">\n\t\t\t<h3 id=\"p-navigation-label\">Navigation</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-NetHack-Wiki\"><a href=\"/wiki/Main_Page\">NetHack Wiki</a></li><li id=\"n-Forum\"><a href=\"/wiki/Forum:Watercooler\">Forum</a></li><li id=\"n-portal\"><a href=\"/wiki/NetHackWiki:Community_Portal\" title=\"About the project, what you can do, where to find things\">Community portal</a></li><li id=\"n-recentchanges\"><a href=\"/wiki/Special:RecentChanges\" title=\"A list of recent changes in the wiki [r]\" accesskey=\"r\">Recent changes</a></li><li id=\"n-randompage\"><a href=\"/wiki/Special:Random\" title=\"Load a random page [x]\" accesskey=\"x\">Random page</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-Popular_pages\" aria-labelledby=\"p-Popular_pages-label\">\n\t\t\t<h3 id=\"p-Popular_pages-label\">Popular pages</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-Dungeon-features\"><a href=\"/wiki/Dungeon_feature\">Dungeon features</a></li><li id=\"n-Monsters\"><a href=\"/wiki/Monster#Canonical_list_of_monsters\">Monsters</a></li><li id=\"n-In.2FExtrinsics\"><a href=\"/wiki/Property#Intrinsic_properties\">In/Extrinsics</a></li><li id=\"n-Items\"><a href=\"/wiki/Item\">Items</a></li><li id=\"n-Spells\"><a href=\"/wiki/Spellbook#List_of_spellbooks\">Spells</a></li><li id=\"n-Game-options\"><a href=\"/wiki/Options\">Game options</a></li><li id=\"n-Websites\"><a href=\"/wiki/Websites\">Websites</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-contributing\" aria-labelledby=\"p-contributing-label\">\n\t\t\t<h3 id=\"p-contributing-label\">Contributing</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-Style-guide\"><a href=\"/wiki/NetHackWiki:Style_guide\">Style guide</a></li><li id=\"n-help\"><a href=\"/wiki/NetHackWiki:How_to_help\" title=\"The place to find out\">How to help</a></li><li id=\"n-Current-projects\"><a href=\"/wiki/NetHackWiki:Current_projects\">Current projects</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-tb\" aria-labelledby=\"p-tb-label\">\n\t\t\t<h3 id=\"p-tb-label\">Tools</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"t-whatlinkshere\"><a href=\"/wiki/Special:WhatLinksHere/Nhraykey.dll\" title=\"A list of all wiki pages that link here [j]\" accesskey=\"j\">What links here</a></li><li id=\"t-recentchangeslinked\"><a href=\"/wiki/Special:RecentChangesLinked/Nhraykey.dll\" rel=\"nofollow\" title=\"Recent changes in pages linked from this page [k]\" accesskey=\"k\">Related changes</a></li><li id=\"t-specialpages\"><a href=\"/wiki/Special:SpecialPages\" title=\"A list of all special pages [q]\" accesskey=\"q\">Special pages</a></li><li id=\"t-print\"><a href=\"/index.php?title=Nhraykey.dll&amp;printable=yes\" rel=\"alternate\" title=\"Printable version of this page [p]\" accesskey=\"p\">Printable version</a></li><li id=\"t-permalink\"><a href=\"/index.php?title=Nhraykey.dll&amp;oldid=146101\" title=\"Permanent link to this revision of the page\">Permanent link</a></li><li id=\"t-info\"><a href=\"/index.php?title=Nhraykey.dll&amp;action=info\" title=\"More information about this page\">Page information</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t\t</div>\n\t\t</div>\n\t\t\t\t<div id=\"footer\" role=\"contentinfo\">\n\t\t\t\t\t\t<ul id=\"footer-info\">\n\t\t\t\t\t\t\t\t<li id=\"footer-info-lastmod\"> This page was last edited on 5 June 2022, at 23:05.</li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t<ul id=\"footer-places\">\n\t\t\t\t\t\t\t\t<li id=\"footer-places-about\"><a href=\"/wiki/NetHackWiki:About\" title=\"NetHackWiki:About\">About NetHackWiki</a></li>\n\t\t\t\t\t\t\t\t<li id=\"footer-places-disclaimer\"><a href=\"/wiki/NetHackWiki:General_disclaimer\" title=\"NetHackWiki:General disclaimer\">Disclaimers</a></li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t\t\t\t<ul id=\"footer-icons\" class=\"noprint\">\n\t\t\t\t\t\t\t\t\t\t<li id=\"footer-poweredbyico\">\n\t\t\t\t\t\t<a href=\"//www.mediawiki.org/\"><img src=\"/resources/assets/poweredby_mediawiki_88x31.png\" alt=\"Powered by MediaWiki\" srcset=\"/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x\" width=\"88\" height=\"31\"/></a>\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t<div style=\"clear: both;\"></div>\n\t\t</div>\n\t\t\n<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({\"wgPageParseReport\":{\"limitreport\":{\"cputime\":\"0.016\",\"walltime\":\"0.049\",\"ppvisitednodes\":{\"value\":142,\"limit\":1000000},\"ppgeneratednodes\":{\"value\":1091,\"limit\":1000000},\"postexpandincludesize\":{\"value\":1730,\"limit\":2097152},\"templateargumentsize\":{\"value\":262,\"limit\":2097152},\"expansiondepth\":{\"value\":8,\"limit\":40},\"expensivefunctioncount\":{\"value\":0,\"limit\":100},\"unstrip-depth\":{\"value\":0,\"limit\":20},\"unstrip-size\":{\"value\":509,\"limit\":5000000},\"timingprofile\":[\"100.00%   21.927      1 -total\",\" 54.12%   11.868      1 Template:Nethack-361\",\" 35.12%    7.700      1 Template:Version_icon\",\" 19.51%    4.277      1 Template:Main\",\" 17.59%    3.856      1 Template:Top_icon\"]},\"cachereport\":{\"timestamp\":\"20240926185420\",\"ttl\":604800,\"transientcontent\":false}}});mw.config.set({\"wgBackendResponseTime\":127});});</script>\n\t</body>\n</html>\n","rawPage":"'''Nhraykey.dll''' is a keyboard handler for the [[Microsoft Windows]] text-mode version of [[NetHack 3.4.3]].  Its purpose is to improve handling of keyboards with non-USA layouts.\n\nThis is a separate DLL in NetHack 3.4.2 through 3.6.6. In the current development version, it is merged into the main binary, along with its alternatives, nhdefkey.dll and nh340key.dll.\n\n== How it works ==\n\nNetHack wants both keyboard and mouse input, but the Win32 console APIs provide no easy way of getting mouse input and also translating keystrokes according to the user's locale.  The ReadConsole API retrieves keystrokes and translates them properly, but discards mouse events.  The ReadConsoleInput API retrieves key and mouse events but does not translate the keys.\n\n[[NetHack 3.4.1]] attempted to solve this problem by reading all input with ReadConsoleInput and passing it to the ToAscii API.  The default keyboard handler, [[nhdefkey.dll]], still works this way.  This approach, however, only seems to work with USA keyboards.  With others, it ends up using the USA layout, and the user is likely to find this confusing.\n\nNhraykey.dll takes a different approach.  First, it notes that commands have different needs from prompts:\n* When NetHack is waiting for a command, such as (d)rop or one of the hjklyubn keys, it wants any of three kinds of input:  an [[ASCII]] character, a character with the eighth bit set to indicate an Alt sequence, or a mouse event.  We do not want to send a non-ASCII character except in response to an Alt sequence, else the game might give surprising behavior, even accidentally invoking the #[[quit]] command.\n* When NetHack has prompted for text, the mouse is unimportant, and we don't want Alt sequences; but we do want any character that the user can type, ASCII or not.\n\nSo it separates these two functions, which had previously been one, and solves the problem according to the needs of each mode.  For a command, it first uses PeekConsoleInput to determine what type of input is available.  For a key event, it goes to ReadConsole to retrieve the key properly translated.  For a mouse event, it goes to ReadConsoleInput to fetch the event.\n\nThe idea is never to call ReadConsole when a mouse event is important, unless we can be sure that it will not block; if that happened, the mouse would cease to function until it returned.  ReadConsole is prevented from blocking by pushing a bogus key event on the queue; if there's nothing else for ReadConsole to fetch, it will fetch the bogus key.  The bogus key is constructed so that it does not match any real key event, and can be filtered out.\n\nFor prompts, ReadConsole is used directly, because mouse events are not needed.\n\n== Bug W343-4 ==\n\n{{main|W343-4}}\n\nThere is one point at which the unmodified nhraykey.dll needs to filter the bogus key, but fails to do so.  This can result in ReadConsole being called and blocking because there is no real key for it to read.  A [[patch]] is available to fix this bug in 3.4.3, and it is fixed in 3.6.1.<ref>[https://github.com/NetHack/NetHack/commit/78857961d2b40f01516ec3ecdafd348c79142bbc#diff-fa02d0cc210b095a04eaed9c7fbbd331 DevTeam GitHub repository, commit 7885796.]</ref>\n\n== Further reading ==\n\n[http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/76c79f23e56a210f The patch] against [[NetHack 3.4.1]] that became nhraykey.dll.\n\n[http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/5218c0df964795f7 Description] of the patch.\n\n[http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/e92013db64618fe3 Fix] for bug W343-4.\n\n== References ==\n<references/>\n\n[[Category:Annotations]]\n{{nethack-361}}"}