{"title":"W343-4","url":"https://nethackwiki.com/wiki/W343-4","type":"markdown","data":"| **Win32 locales fix**                                                    |                                                |\n| ------------------------------------------------------------------------ | ---------------------------------------------- |\n| Author                                                                   | Ray Chason                                     |\n| Download                                                                 | [link](http://nhpatchdb.alt.org/?download=313) |\n| [NetHack PatchDB](/wiki/NetHack_Patch_Database \"NetHack Patch Database\") | [313](http://nhpatchdb.alt.org/?313)           |\n\n**W343-4** designates a [bug](/wiki/Bugs_in_NetHack_3.4.3#W343-4 \"Bugs in NetHack 3.4.3\") that affects the [Microsoft Windows](/wiki/Microsoft_Windows \"Microsoft Windows\") version of [NetHack 3.4.2](/wiki/NetHack_3.4.2 \"NetHack 3.4.2\"), [3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\") and [3.6.0](/wiki/NetHack_3.6.0 \"NetHack 3.6.0\"). It occurs when the keyboard handler [nhraykey.dll](/wiki/Nhraykey.dll \"Nhraykey.dll\") is loaded and causes minor problems with the keyboard when performing certain acts, such as locking a [door](/wiki/Door \"Door\").\n\nA [patch](/wiki/Patch \"Patch\") is available to fix this bug at the [NetHack Patch Database](/wiki/NetHack_Patch_Database \"NetHack Patch Database\"), [here](http://nhpatchdb.alt.org/?313); it also fixes [W343-3](/wiki/W343-3 \"W343-3\"). Although the [DevTeam](/wiki/DevTeam \"DevTeam\") lists this bug as fixed in the next release, it is *not* fixed in [NetHack 3.6.0](/wiki/NetHack_3.6.0 \"NetHack 3.6.0\"). It is fixed in [NetHack 3.6.1](/wiki/NetHack_3.6.1 \"NetHack 3.6.1\").[\\[1\\]](#cite_note-1)\n\n[ ]\n\n## Contents\n\n- [1 Nature of the bug](#Nature_of_the_bug)\n- [2 Cause of the bug](#Cause_of_the_bug)\n- [3 Versions affected](#Versions_affected)\n- [4 Patch](#Patch)\n- [5 References](#References)\n\n## Nature of the bug\n\nBug W343-4 affects all users of NetHack on Windows who use the text mode [user interface](/wiki/User_interface \"User interface\") and the keyboard handler nhraykey.dll.\n\nAfter performing any act that takes multiple turns and can be interrupted, such as locking a [door](/wiki/Door \"Door\"), the game seems to stop responding. It is necessary to press a key to get it to continue.\n\nThis bug is an annoyance rather than a showstopper, but has perhaps slowed the acceptance of nhraykey.dll, despite its improved handling of non-USA (and especially non-English) keyboards.\n\n## Cause of the bug\n\nNhraykey.dll seeks to read both keyboard and mouse input, while translating the keystrokes according to the user's configured localization settings. The Win32 API does not make this task easy: ReadConsole translates the keystrokes, but ignores the mouse, while ReadConsoleInput reads the mouse, but does not translate the keystrokes. Nhraykey.dll solves this problem by calling PeekConsoleInput first, and then calling ReadConsole to retrieve any keystrokes and ReadConsoleInput to clear out anything else.\n\nThe complication is that there can be a keystroke, but the call to ReadConsole may still block, keeping the mouse from responding, because the key was a [dead key](http://en.wikipedia.org/wiki/dead_key \"wikipedia:dead key\"). Nhraykey.dll prevents the blocking by pushing a bogus key event on the queue before calling ReadConsole; if nothing else, the ReadConsole call will return the bogus key.\n\nThe bogus key is supposed to be ignored when it is read. The bug is that one particular function, NHkbhit(), doesn't do this. It returns a true status, indicating that a real key is available, and allmain.c then calls Getchar() to retrieve this nonexistent key. The user must eventually provide a real key for Getchar() to return.\n\n## Versions affected\n\nThe versions affected are [NetHack 3.4.2](/wiki/NetHack_3.4.2 \"NetHack 3.4.2\"), [NetHack 3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\") and [NetHack 3.6.0](/wiki/NetHack_3.6.0 \"NetHack 3.6.0\").\n\n## Patch\n\nA [patch](/wiki/Patch \"Patch\") is available to fix this bug, as [this post](http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/e92013db64618fe3) to [rec.games.roguelike.nethack](/wiki/Rec.games.roguelike.nethack \"Rec.games.roguelike.nethack\"). The patch is against [NetHack 3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\") and may or may not apply cleanly to [NetHack 3.6.0](/wiki/NetHack_3.6.0 \"NetHack 3.6.0\"). No binaries or variants other than [Spanish NetHack](/index.php?title=Spanish_NetHack\\&action=edit\\&redlink=1 \"Spanish NetHack (page does not exist)\") are known to incorporate the pach.\n\nThe fix is to add a check for the bogus key in NHkbhit(). If found, the bogus key is discarded and the queue is queried again.\n\n## References\n\n1. [↑](#cite_ref-1) [DevTeam GitHub repository, commit 7885796.](https://github.com/NetHack/NetHack/commit/78857961d2b40f01516ec3ecdafd348c79142bbc#diff-fa02d0cc210b095a04eaed9c7fbbd331)\n\n[![This article is unlikely to require revision for the next version of NetHack. Click here for more information.](/images/5/58/Noversion.png)](/wiki/NetHackWiki:Next_version \"This article is unlikely to require revision for the next version of NetHack. Click here for more information.\")\n","html":"<!DOCTYPE html>\n<html class=\"client-nojs\" lang=\"en\" dir=\"ltr\">\n<head>\n<meta charset=\"UTF-8\"/>\n<title>W343-4 - NetHack Wiki</title>\n<script>document.documentElement.className = document.documentElement.className.replace( /(^|\\s)client-nojs(\\s|$)/, \"$1client-js$2\" );</script>\n<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({\"wgCanonicalNamespace\":\"\",\"wgCanonicalSpecialPageName\":false,\"wgNamespaceNumber\":0,\"wgPageName\":\"W343-4\",\"wgTitle\":\"W343-4\",\"wgCurRevisionId\":159060,\"wgRevisionId\":159060,\"wgArticleId\":4351,\"wgIsArticle\":true,\"wgIsRedirect\":false,\"wgAction\":\"view\",\"wgUserName\":null,\"wgUserGroups\":[\"*\"],\"wgCategories\":[\"Bugs\"],\"wgBreakFrames\":false,\"wgPageContentLanguage\":\"en\",\"wgPageContentModel\":\"wikitext\",\"wgSeparatorTransformTable\":[\"\",\"\"],\"wgDigitTransformTable\":[\"\",\"\"],\"wgDefaultDateFormat\":\"dmy\",\"wgMonthNames\":[\"\",\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"wgMonthNamesShort\":[\"\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"wgRelevantPageName\":\"W343-4\",\"wgRelevantArticleId\":4351,\"wgRequestId\":\"15723258b9363abde4b0acfc\",\"wgCSPNonce\":false,\"wgIsProbablyEditable\":false,\"wgRelevantPageIsProbablyEditable\":false,\"wgRestrictionEdit\":[],\"wgRestrictionMove\":[],\"wgWikiEditorEnabledModules\":[],\"wgCategoryTreePageCategoryOptions\":\"{\\\"mode\\\":0,\\\"hideprefix\\\":20,\\\"showcount\\\":true,\\\"namespaces\\\":false}\"});mw.loader.state({\"site.styles\":\"ready\",\"noscript\":\"ready\",\"user.styles\":\"ready\",\"user\":\"ready\",\"user.options\":\"ready\",\"user.tokens\":\"loading\",\"ext.cite.styles\":\"ready\",\"mediawiki.legacy.shared\":\"ready\",\"mediawiki.legacy.commonPrint\":\"ready\",\"mediawiki.toc.styles\":\"ready\",\"mediawiki.skinning.interface\":\"ready\",\"skins.vector.styles\":\"ready\"});mw.loader.implement(\"user.tokens@0tffind\",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({\"editToken\":\"+\\\\\",\"patrolToken\":\"+\\\\\",\"watchToken\":\"+\\\\\",\"csrfToken\":\"+\\\\\"});\n});RLPAGEMODULES=[\"ext.cite.a11y\",\"site\",\"mediawiki.page.startup\",\"mediawiki.user\",\"mediawiki.page.ready\",\"mediawiki.toc\",\"mediawiki.searchSuggest\",\"skins.vector.js\"];mw.loader.load(RLPAGEMODULES);});</script>\n<link rel=\"stylesheet\" href=\"/load.php?debug=false&amp;lang=en&amp;modules=ext.cite.styles%7Cmediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.skinning.interface%7Cmediawiki.toc.styles%7Cskins.vector.styles&amp;only=styles&amp;skin=vector\"/>\n<script async=\"\" src=\"/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector\"></script>\n<meta name=\"ResourceLoaderDynamicStyles\" content=\"\"/>\n<link rel=\"stylesheet\" href=\"/load.php?debug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector\"/>\n<meta name=\"generator\" content=\"MediaWiki 1.32.5\"/>\n<meta name=\"description\" content=\"W343-4 designates a bug that affects the Microsoft Windows version of NetHack 3.4.2, 3.4.3 and 3.6.0.  It occurs when the keyboard handler nhraykey.dll is loaded and causes minor problems with the keyboard when performing certain acts, such as locking a door.\"/>\n<link rel=\"image_src\" href=\"/images/6/65/Nethackwiki-logo.png\"/>\n<link rel=\"shortcut icon\" href=\"/images/6/64/Favicon.ico\"/>\n<link rel=\"search\" type=\"application/opensearchdescription+xml\" href=\"/opensearch_desc.php\" title=\"NetHackWiki\"/>\n<link rel=\"EditURI\" type=\"application/rsd+xml\" href=\"https://nethackwiki.com/api.php?action=rsd\"/>\n<link rel=\"canonical\" href=\"/wiki/W343-4\"/>\n<!--[if lt IE 9]><script src=\"/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=vector&amp;sync=1\"></script><![endif]-->\n</head>\n<body class=\"mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-W343-4 rootpage-W343-4 skin-vector action-view\">\t\t<div id=\"mw-page-base\" class=\"noprint\"></div>\n\t\t<div id=\"mw-head-base\" class=\"noprint\"></div>\n\t\t<div id=\"content\" class=\"mw-body\" role=\"main\">\n\t\t\t<a id=\"top\"></a>\n\t\t\t<div class=\"mw-indicators mw-body-content\">\n</div>\n<h1 id=\"firstHeading\" class=\"firstHeading\" lang=\"en\">W343-4</h1>\t\t\t<div id=\"bodyContent\" class=\"mw-body-content\">\n\t\t\t\t<div id=\"siteSub\" class=\"noprint\">From NetHackWiki</div>\t\t\t\t<div id=\"contentSub\"></div>\n\t\t\t\t<div id=\"jump-to-nav\"></div>\t\t\t\t<a class=\"mw-jump-link\" href=\"#mw-head\">Jump to navigation</a>\n\t\t\t\t<a class=\"mw-jump-link\" href=\"#p-search\">Jump to search</a>\n\t\t\t\t<div id=\"mw-content-text\" lang=\"en\" dir=\"ltr\" class=\"mw-content-ltr\"><div class=\"mw-parser-output\"><div class=\"thumb tright\">\n<table class=\"prettytable\" style=\"margin:0\">\n<tbody><tr>\n<th colspan=\"2\"><b>Win32 locales fix</b>\n</th></tr>\n<tr>\n<th>Author\n</th>\n<td>Ray Chason\n</td></tr>\n<tr>\n<th>Download\n</th>\n<td><a class=\"external text\" href=\"http://nhpatchdb.alt.org/?download=313\">link</a>\n</td></tr>\n<tr>\n<th><a href=\"/wiki/NetHack_Patch_Database\" title=\"NetHack Patch Database\">NetHack PatchDB</a>\n</th>\n<td style=\"background-color: #ccffcc;\"><a class=\"external text\" href=\"http://nhpatchdb.alt.org/?313\">313</a>\n</td></tr></tbody></table>\n</div>\n<p><b>W343-4</b> designates a <a href=\"/wiki/Bugs_in_NetHack_3.4.3#W343-4\" title=\"Bugs in NetHack 3.4.3\">bug</a> that affects the <a href=\"/wiki/Microsoft_Windows\" title=\"Microsoft Windows\">Microsoft Windows</a> version of <a href=\"/wiki/NetHack_3.4.2\" title=\"NetHack 3.4.2\">NetHack 3.4.2</a>, <a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">3.4.3</a> and <a href=\"/wiki/NetHack_3.6.0\" title=\"NetHack 3.6.0\">3.6.0</a>.  It occurs when the keyboard handler <a href=\"/wiki/Nhraykey.dll\" title=\"Nhraykey.dll\">nhraykey.dll</a> is loaded and causes minor problems with the keyboard when performing certain acts, such as locking a <a href=\"/wiki/Door\" title=\"Door\">door</a>.\n</p><p>A <a href=\"/wiki/Patch\" title=\"Patch\">patch</a> is available to fix this bug at the <a href=\"/wiki/NetHack_Patch_Database\" title=\"NetHack Patch Database\">NetHack Patch Database</a>, <a class=\"external text\" href=\"http://nhpatchdb.alt.org/?313\">here</a>; it also fixes <a href=\"/wiki/W343-3\" title=\"W343-3\">W343-3</a>.  Although the <a href=\"/wiki/DevTeam\" title=\"DevTeam\">DevTeam</a> lists this bug as fixed in the next release, it is <i>not</i> fixed in <a href=\"/wiki/NetHack_3.6.0\" title=\"NetHack 3.6.0\">NetHack 3.6.0</a>. It is fixed in <a href=\"/wiki/NetHack_3.6.1\" title=\"NetHack 3.6.1\">NetHack 3.6.1</a>.<sup id=\"cite_ref-1\" class=\"reference\"><a href=\"#cite_note-1\">&#91;1&#93;</a></sup>\n</p>\n<div id=\"toc\" class=\"toc\"><input type=\"checkbox\" role=\"button\" id=\"toctogglecheckbox\" class=\"toctogglecheckbox\" style=\"display:none\" /><div class=\"toctitle\" lang=\"en\" dir=\"ltr\"><h2>Contents</h2><span class=\"toctogglespan\"><label class=\"toctogglelabel\" for=\"toctogglecheckbox\"></label></span></div>\n<ul>\n<li class=\"toclevel-1 tocsection-1\"><a href=\"#Nature_of_the_bug\"><span class=\"tocnumber\">1</span> <span class=\"toctext\">Nature of the bug</span></a></li>\n<li class=\"toclevel-1 tocsection-2\"><a href=\"#Cause_of_the_bug\"><span class=\"tocnumber\">2</span> <span class=\"toctext\">Cause of the bug</span></a></li>\n<li class=\"toclevel-1 tocsection-3\"><a href=\"#Versions_affected\"><span class=\"tocnumber\">3</span> <span class=\"toctext\">Versions affected</span></a></li>\n<li class=\"toclevel-1 tocsection-4\"><a href=\"#Patch\"><span class=\"tocnumber\">4</span> <span class=\"toctext\">Patch</span></a></li>\n<li class=\"toclevel-1 tocsection-5\"><a href=\"#References\"><span class=\"tocnumber\">5</span> <span class=\"toctext\">References</span></a></li>\n</ul>\n</div>\n\n<h2><span class=\"mw-headline\" id=\"Nature_of_the_bug\">Nature of the bug</span></h2>\n<p>Bug W343-4 affects all users of NetHack on Windows who use the text mode <a href=\"/wiki/User_interface\" title=\"User interface\">user interface</a> and the keyboard handler nhraykey.dll.\n</p><p>After performing any act that takes multiple turns and can be interrupted, such as locking a <a href=\"/wiki/Door\" title=\"Door\">door</a>, the game seems to stop responding.  It is necessary to press a key to get it to continue.  \n</p><p>This bug is an annoyance rather than a showstopper, but has perhaps slowed the acceptance of nhraykey.dll, despite its improved handling of non-USA (and especially non-English) keyboards.\n</p>\n<h2><span class=\"mw-headline\" id=\"Cause_of_the_bug\">Cause of the bug</span></h2>\n<p>Nhraykey.dll seeks to read both keyboard and mouse input, while translating the keystrokes according to the user's configured localization settings.  The Win32 API does not make this task easy:  ReadConsole translates the keystrokes, but ignores the mouse, while ReadConsoleInput reads the mouse, but does not translate the keystrokes.  Nhraykey.dll solves this problem by calling PeekConsoleInput first, and then calling ReadConsole to retrieve any keystrokes and ReadConsoleInput to clear out anything else.\n</p><p>The complication is that there can be a keystroke, but the call to ReadConsole may still block, keeping the mouse from responding, because the key was a <a href=\"http://en.wikipedia.org/wiki/dead_key\" class=\"extiw\" title=\"wikipedia:dead key\">dead key</a>.  Nhraykey.dll prevents the blocking by pushing a bogus key event on the queue before calling ReadConsole; if nothing else, the ReadConsole call will return the bogus key.\n</p><p>The bogus key is supposed to be ignored when it is read.  The bug is that one particular function, NHkbhit(), doesn't do this.  It returns a true status, indicating that a real key is available, and allmain.c then calls Getchar() to retrieve this nonexistent key.  The user must eventually provide a real key for Getchar() to return.\n</p>\n<h2><span class=\"mw-headline\" id=\"Versions_affected\">Versions affected</span></h2>\n<p>The versions affected are <a href=\"/wiki/NetHack_3.4.2\" title=\"NetHack 3.4.2\">NetHack 3.4.2</a>, <a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">NetHack 3.4.3</a> and <a href=\"/wiki/NetHack_3.6.0\" title=\"NetHack 3.6.0\">NetHack 3.6.0</a>.\n</p>\n<h2><span class=\"mw-headline\" id=\"Patch\">Patch</span></h2>\n<p>A <a href=\"/wiki/Patch\" title=\"Patch\">patch</a> is available to fix this bug, as <a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/e92013db64618fe3\">this post</a> to <a href=\"/wiki/Rec.games.roguelike.nethack\" title=\"Rec.games.roguelike.nethack\">rec.games.roguelike.nethack</a>.  The patch is against <a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">NetHack 3.4.3</a> and may or may not apply cleanly to <a href=\"/wiki/NetHack_3.6.0\" title=\"NetHack 3.6.0\">NetHack 3.6.0</a>.  No binaries or variants other than <a href=\"/index.php?title=Spanish_NetHack&amp;action=edit&amp;redlink=1\" class=\"new\" title=\"Spanish NetHack (page does not exist)\">Spanish NetHack</a> are known to incorporate the pach.\n</p><p>The fix is to add a check for the bogus key in NHkbhit().  If found, the bogus key is discarded and the queue is queried again.\n</p>\n<h2><span class=\"mw-headline\" id=\"References\">References</span></h2>\n<div class=\"mw-references-wrap\"><ol class=\"references\">\n<li id=\"cite_note-1\"><span class=\"mw-cite-backlink\"><a href=\"#cite_ref-1\">↑</a></span> <span class=\"reference-text\"><a class=\"external text\" href=\"https://github.com/NetHack/NetHack/commit/78857961d2b40f01516ec3ecdafd348c79142bbc#diff-fa02d0cc210b095a04eaed9c7fbbd331\">DevTeam GitHub repository, commit 7885796.</a></span>\n</li>\n</ol></div>\n<p><br />\n</p>\n<div style=\"display:none; right:10px; padding-bottom: 17px\" class=\"metadata topicon nopopups\"><div style=\"margin-top: -10px\"><a href=\"/wiki/NetHackWiki:Next_version\" title=\"This article is unlikely to require revision for the next version of NetHack. Click here for more information.\"><img alt=\"This article is unlikely to require revision for the next version of NetHack. Click here for more information.\" src=\"/images/5/58/Noversion.png\" width=\"32\" height=\"32\" /></a></div></div>\n\n<!-- \nNewPP limit report\nCached time: 20240926191218\nCache expiry: 604800\nDynamic content: false\nCPU time usage: 0.016 seconds\nReal time usage: 0.031 seconds\nPreprocessor visited node count: 131/1000000\nPreprocessor generated node count: 633/1000000\nPost‐expand include size: 1673/2097152 bytes\nTemplate argument size: 404/2097152 bytes\nHighest expansion depth: 8/40\nExpensive parser function count: 0/100\nUnstrip recursion depth: 0/20\nUnstrip post‐expand size: 481/5000000 bytes\n-->\n<!--\nTransclusion expansion time report (%,ms,calls,template)\n100.00%   13.684      1 -total\n 66.51%    9.101      1 Template:Noversion\n 41.68%    5.704      1 Template:Version_icon\n 29.64%    4.056      1 Template:Top_icon\n 19.34%    2.646      1 Template:Patch\n-->\n\n<!-- Saved in parser cache with key wikihackdb:pcache:idhash:4351-0!canonical and timestamp 20240926191218 and revision id 159060\n -->\n</div></div>\t\t\t\t\t<div class=\"printfooter\">\n\t\t\t\t\t\tRetrieved from \"<a dir=\"ltr\" href=\"https://nethackwiki.com/index.php?title=W343-4&amp;oldid=159060\">https://nethackwiki.com/index.php?title=W343-4&amp;oldid=159060</a>\"\t\t\t\t\t</div>\n\t\t\t\t<div id=\"catlinks\" class=\"catlinks\" data-mw=\"interface\"><div id=\"mw-normal-catlinks\" class=\"mw-normal-catlinks\"><a href=\"/wiki/Special:Categories\" title=\"Special:Categories\">Category</a>: <ul><li><a href=\"/wiki/Category:Bugs\" title=\"Category:Bugs\">Bugs</a></li></ul></div></div>\t\t\t\t<div class=\"visualClear\"></div>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t<div id=\"mw-navigation\">\n\t\t\t<h2>Navigation menu</h2>\n\t\t\t<div id=\"mw-head\">\n\t\t\t\t\t\t\t\t\t<div id=\"p-personal\" role=\"navigation\" class=\"\" aria-labelledby=\"p-personal-label\">\n\t\t\t\t\t\t<h3 id=\"p-personal-label\">Personal tools</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"pt-createaccount\"><a href=\"/index.php?title=Special:CreateAccount&amp;returnto=W343-4\" title=\"You are encouraged to create an account and log in; however, it is not mandatory\">Create account</a></li><li id=\"pt-login\"><a href=\"/index.php?title=Special:UserLogin&amp;returnto=W343-4\" title=\"You are encouraged to log in; however, it is not mandatory [o]\" accesskey=\"o\">Log in</a></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div id=\"left-navigation\">\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-namespaces\" role=\"navigation\" class=\"vectorTabs\" aria-labelledby=\"p-namespaces-label\">\n\t\t\t\t\t\t<h3 id=\"p-namespaces-label\">Namespaces</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"ca-nstab-main\" class=\"selected\"><span><a href=\"/wiki/W343-4\" title=\"View the content page [c]\" accesskey=\"c\">Page</a></span></li><li id=\"ca-talk\"><span><a href=\"/wiki/Talk:W343-4\" rel=\"discussion\" title=\"Discussion about the content page [t]\" accesskey=\"t\">Discussion</a></span></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-variants\" role=\"navigation\" class=\"vectorMenu emptyPortlet\" aria-labelledby=\"p-variants-label\">\n\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" class=\"vectorMenuCheckbox\" aria-labelledby=\"p-variants-label\" />\n\t\t\t\t\t\t<h3 id=\"p-variants-label\">\n\t\t\t\t\t\t\t<span>Variants</span>\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div class=\"menu\">\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t<div id=\"right-navigation\">\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-views\" role=\"navigation\" class=\"vectorTabs\" aria-labelledby=\"p-views-label\">\n\t\t\t\t\t\t<h3 id=\"p-views-label\">Views</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"ca-view\" class=\"collapsible selected\"><span><a href=\"/wiki/W343-4\">Read</a></span></li><li id=\"ca-viewsource\" class=\"collapsible\"><span><a href=\"/index.php?title=W343-4&amp;action=edit\" title=\"This page is protected.&#10;You can view its source [e]\" accesskey=\"e\">View source</a></span></li><li id=\"ca-history\" class=\"collapsible\"><span><a href=\"/index.php?title=W343-4&amp;action=history\" title=\"Past revisions of this page [h]\" accesskey=\"h\">View history</a></span></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-cactions\" role=\"navigation\" class=\"vectorMenu emptyPortlet\" aria-labelledby=\"p-cactions-label\">\n\t\t\t\t\t\t<input type=\"checkbox\" class=\"vectorMenuCheckbox\" aria-labelledby=\"p-cactions-label\" />\n\t\t\t\t\t\t<h3 id=\"p-cactions-label\"><span>More</span></h3>\n\t\t\t\t\t\t<div class=\"menu\">\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-search\" role=\"search\">\n\t\t\t\t\t\t<h3>\n\t\t\t\t\t\t\t<label for=\"searchInput\">Search</label>\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<form action=\"/index.php\" id=\"searchform\">\n\t\t\t\t\t\t\t<div id=\"simpleSearch\">\n\t\t\t\t\t\t\t\t<input type=\"search\" name=\"search\" placeholder=\"Search NetHackWiki\" title=\"Search NetHackWiki [f]\" accesskey=\"f\" id=\"searchInput\"/><input type=\"hidden\" value=\"Special:Search\" name=\"title\"/><input type=\"submit\" name=\"fulltext\" value=\"Search\" title=\"Search the pages for this text\" id=\"mw-searchButton\" class=\"searchButton mw-fallbackSearchButton\"/><input type=\"submit\" name=\"go\" value=\"Go\" title=\"Go to a page with this exact name if it exists\" id=\"searchButton\" class=\"searchButton\"/>\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id=\"mw-panel\">\n\t\t\t\t<div id=\"p-logo\" role=\"banner\"><a class=\"mw-wiki-logo\" href=\"/wiki/Main_Page\"  title=\"Visit the main page\"></a></div>\n\t\t\t\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-navigation\" aria-labelledby=\"p-navigation-label\">\n\t\t\t<h3 id=\"p-navigation-label\">Navigation</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-NetHack-Wiki\"><a href=\"/wiki/Main_Page\">NetHack Wiki</a></li><li id=\"n-Forum\"><a href=\"/wiki/Forum:Watercooler\">Forum</a></li><li id=\"n-portal\"><a href=\"/wiki/NetHackWiki:Community_Portal\" title=\"About the project, what you can do, where to find things\">Community portal</a></li><li id=\"n-recentchanges\"><a href=\"/wiki/Special:RecentChanges\" title=\"A list of recent changes in the wiki [r]\" accesskey=\"r\">Recent changes</a></li><li id=\"n-randompage\"><a href=\"/wiki/Special:Random\" title=\"Load a random page [x]\" accesskey=\"x\">Random page</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-Popular_pages\" aria-labelledby=\"p-Popular_pages-label\">\n\t\t\t<h3 id=\"p-Popular_pages-label\">Popular pages</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-Dungeon-features\"><a href=\"/wiki/Dungeon_feature\">Dungeon features</a></li><li id=\"n-Monsters\"><a href=\"/wiki/Monster#Canonical_list_of_monsters\">Monsters</a></li><li id=\"n-In.2FExtrinsics\"><a href=\"/wiki/Property#Intrinsic_properties\">In/Extrinsics</a></li><li id=\"n-Items\"><a href=\"/wiki/Item\">Items</a></li><li id=\"n-Spells\"><a href=\"/wiki/Spellbook#List_of_spellbooks\">Spells</a></li><li id=\"n-Game-options\"><a href=\"/wiki/Options\">Game options</a></li><li id=\"n-Websites\"><a href=\"/wiki/Websites\">Websites</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-contributing\" aria-labelledby=\"p-contributing-label\">\n\t\t\t<h3 id=\"p-contributing-label\">Contributing</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-Style-guide\"><a href=\"/wiki/NetHackWiki:Style_guide\">Style guide</a></li><li id=\"n-help\"><a href=\"/wiki/NetHackWiki:How_to_help\" title=\"The place to find out\">How to help</a></li><li id=\"n-Current-projects\"><a href=\"/wiki/NetHackWiki:Current_projects\">Current projects</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-tb\" aria-labelledby=\"p-tb-label\">\n\t\t\t<h3 id=\"p-tb-label\">Tools</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"t-whatlinkshere\"><a href=\"/wiki/Special:WhatLinksHere/W343-4\" title=\"A list of all wiki pages that link here [j]\" accesskey=\"j\">What links here</a></li><li id=\"t-recentchangeslinked\"><a href=\"/wiki/Special:RecentChangesLinked/W343-4\" rel=\"nofollow\" title=\"Recent changes in pages linked from this page [k]\" accesskey=\"k\">Related changes</a></li><li id=\"t-specialpages\"><a href=\"/wiki/Special:SpecialPages\" title=\"A list of all special pages [q]\" accesskey=\"q\">Special pages</a></li><li id=\"t-print\"><a href=\"/index.php?title=W343-4&amp;printable=yes\" rel=\"alternate\" title=\"Printable version of this page [p]\" accesskey=\"p\">Printable version</a></li><li id=\"t-permalink\"><a href=\"/index.php?title=W343-4&amp;oldid=159060\" title=\"Permanent link to this revision of the page\">Permanent link</a></li><li id=\"t-info\"><a href=\"/index.php?title=W343-4&amp;action=info\" title=\"More information about this page\">Page information</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t\t</div>\n\t\t</div>\n\t\t\t\t<div id=\"footer\" role=\"contentinfo\">\n\t\t\t\t\t\t<ul id=\"footer-info\">\n\t\t\t\t\t\t\t\t<li id=\"footer-info-lastmod\"> This page was last edited on 21 December 2023, at 01:36.</li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t<ul id=\"footer-places\">\n\t\t\t\t\t\t\t\t<li id=\"footer-places-about\"><a href=\"/wiki/NetHackWiki:About\" title=\"NetHackWiki:About\">About NetHackWiki</a></li>\n\t\t\t\t\t\t\t\t<li id=\"footer-places-disclaimer\"><a href=\"/wiki/NetHackWiki:General_disclaimer\" title=\"NetHackWiki:General disclaimer\">Disclaimers</a></li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t\t\t\t<ul id=\"footer-icons\" class=\"noprint\">\n\t\t\t\t\t\t\t\t\t\t<li id=\"footer-poweredbyico\">\n\t\t\t\t\t\t<a href=\"//www.mediawiki.org/\"><img src=\"/resources/assets/poweredby_mediawiki_88x31.png\" alt=\"Powered by MediaWiki\" srcset=\"/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x\" width=\"88\" height=\"31\"/></a>\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t<div style=\"clear: both;\"></div>\n\t\t</div>\n\t\t\n<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({\"wgPageParseReport\":{\"limitreport\":{\"cputime\":\"0.016\",\"walltime\":\"0.031\",\"ppvisitednodes\":{\"value\":131,\"limit\":1000000},\"ppgeneratednodes\":{\"value\":633,\"limit\":1000000},\"postexpandincludesize\":{\"value\":1673,\"limit\":2097152},\"templateargumentsize\":{\"value\":404,\"limit\":2097152},\"expansiondepth\":{\"value\":8,\"limit\":40},\"expensivefunctioncount\":{\"value\":0,\"limit\":100},\"unstrip-depth\":{\"value\":0,\"limit\":20},\"unstrip-size\":{\"value\":481,\"limit\":5000000},\"timingprofile\":[\"100.00%   13.684      1 -total\",\" 66.51%    9.101      1 Template:Noversion\",\" 41.68%    5.704      1 Template:Version_icon\",\" 29.64%    4.056      1 Template:Top_icon\",\" 19.34%    2.646      1 Template:Patch\"]},\"cachereport\":{\"timestamp\":\"20240926191218\",\"ttl\":604800,\"transientcontent\":false}}});mw.config.set({\"wgBackendResponseTime\":96});});</script>\n\t</body>\n</html>\n","rawPage":"{{patch\n |name=Win32 locales fix\n |author=Ray Chason\n |download=http://nhpatchdb.alt.org/?download=313\n |bilious=313\n}}\n'''W343-4''' designates a [[Bugs in NetHack 3.4.3#W343-4|bug]] that affects the [[Microsoft Windows]] version of [[NetHack 3.4.2]], [[NetHack 3.4.3|3.4.3]] and [[NetHack 3.6.0|3.6.0]].  It occurs when the keyboard handler [[nhraykey.dll]] is loaded and causes minor problems with the keyboard when performing certain acts, such as locking a [[door]].\n\nA [[patch]] is available to fix this bug at the [[NetHack Patch Database]], [http://nhpatchdb.alt.org/?313 here]; it also fixes [[W343-3]].  Although the [[DevTeam]] lists this bug as fixed in the next release, it is ''not'' fixed in [[NetHack 3.6.0]]. It is fixed in [[NetHack 3.6.1]].<ref>[https://github.com/NetHack/NetHack/commit/78857961d2b40f01516ec3ecdafd348c79142bbc#diff-fa02d0cc210b095a04eaed9c7fbbd331 DevTeam GitHub repository, commit 7885796.]</ref>\n\n== Nature of the bug ==\n\nBug W343-4 affects all users of NetHack on Windows who use the text mode [[user interface]] and the keyboard handler nhraykey.dll.\n\nAfter performing any act that takes multiple turns and can be interrupted, such as locking a [[door]], the game seems to stop responding.  It is necessary to press a key to get it to continue.  \n\nThis bug is an annoyance rather than a showstopper, but has perhaps slowed the acceptance of nhraykey.dll, despite its improved handling of non-USA (and especially non-English) keyboards.\n\n== Cause of the bug ==\n\nNhraykey.dll seeks to read both keyboard and mouse input, while translating the keystrokes according to the user's configured localization settings.  The Win32 API does not make this task easy:  ReadConsole translates the keystrokes, but ignores the mouse, while ReadConsoleInput reads the mouse, but does not translate the keystrokes.  Nhraykey.dll solves this problem by calling PeekConsoleInput first, and then calling ReadConsole to retrieve any keystrokes and ReadConsoleInput to clear out anything else.\n\nThe complication is that there can be a keystroke, but the call to ReadConsole may still block, keeping the mouse from responding, because the key was a [[wikipedia:dead key|dead key]].  Nhraykey.dll prevents the blocking by pushing a bogus key event on the queue before calling ReadConsole; if nothing else, the ReadConsole call will return the bogus key.\n\nThe bogus key is supposed to be ignored when it is read.  The bug is that one particular function, NHkbhit(), doesn't do this.  It returns a true status, indicating that a real key is available, and allmain.c then calls Getchar() to retrieve this nonexistent key.  The user must eventually provide a real key for Getchar() to return.\n\n== Versions affected ==\n\nThe versions affected are [[NetHack 3.4.2]], [[NetHack 3.4.3]] and [[NetHack 3.6.0]].\n\n== Patch ==\n\nA [[patch]] is available to fix this bug, as [http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/e92013db64618fe3 this post] to [[rec.games.roguelike.nethack]].  The patch is against [[NetHack 3.4.3]] and may or may not apply cleanly to [[NetHack 3.6.0]].  No binaries or variants other than [[Spanish NetHack]] are known to incorporate the pach.\n\nThe fix is to add a check for the bogus key in NHkbhit().  If found, the bogus key is discarded and the queue is queried again.\n\n== References ==\n<references/>\n\n{{noversion}}\n[[Category:Bugs]]"}