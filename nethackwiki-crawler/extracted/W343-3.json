{"title":"W343-3","url":"https://nethackwiki.com/wiki/W343-3","type":"markdown","data":"|                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |                                                                                   |\n| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------- |\n| **W343-3** designates a [bug](/wiki/Bugs_in_NetHack_3.4.3#W343-3 \"Bugs in NetHack 3.4.3\") that affects the [Microsoft Windows](/wiki/Microsoft_Windows \"Microsoft Windows\") version of [NetHack 3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\"). It is fixed in [NetHack 3.6.0](/wiki/NetHack_3.6.0 \"NetHack 3.6.0\"). The bug is listed as:`Under the Polish version of Windows 2000 SP4, screen output with a raster font shows wrong characters for many dungeon features`[ ]## Contents* [1 Nature of the bug](#Nature_of_the_bug)\n* [2 Cause of the bug](#Cause_of_the_bug)\n  - [2.1 Windows 10](#Windows_10)\n* [3 Versions affected](#Versions_affected)\n* [4 Patch](#Patch) | Win32 locales fix&#xA;Author\tRay Chason&#xA;Download\tlink&#xA;NetHack PatchDB\t313 |\n\n## Nature of the bug\n\nThe bug has been reported on [Polish](http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/4ba778741135464e) and Russian editions of Windows 2000 and on a [Czech](http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/8eea5ab560b85b7b) version of Windows XP. It has been [duplicated](http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/6bd4af64d16878f6) on an American Windows XP by changing a language setting. A [screenshot](http://amiro.republika.pl/nethack/screen1.png) is available.\n\nBug W343-3 really comprises two distinct and unrelated bugs. One is a simple character set issue: many non-USA PCs are configured with different character sets, and seven symbols may look different. This issue is more fully detailed in the [IBMgraphics](/wiki/IBMgraphics \"IBMgraphics\") article.\n\nThe more serious bug is that some characters appear as strange symbols or blank squares. This is not actually a bug in NetHack, but in Windows. The rest of this article will deal with this bug.\n\n## Cause of the bug\n\nThe bug is a flaw in the Windows WriteConsoleOutputCharacterA API. When its configured code page is other than 437 or 850, many non-[ASCII](/wiki/ASCII \"ASCII\") characters can show up incorrectly.\n\nThe bug occurs when four conditions are met:\n\n- The version of Windows is Windows NT or one of its descendants, no later than Windows 8.1. The bug is confirmed to exist on Windows 2000, Windows XP, Windows Vista, Windows 7, Windows 8 and Windows 8.1. It is confirmed to be fixed on Windows 10 (but see the note below on Windows 10).\n- The built-in command shell window is used. Alternate command shell windows are available; [Cmder](http://cmder.net/), in particular, is confirmed *not* to have the bug.\n- A bitmap font, rather than Lucida Console, is selected.\n- The command shell is running in a window, rather than full screen. Windows Vista and later do not support full screen mode in the console, and so this item will always be true for those versions of Windows.\n- The language for non-Unicode programs is set to one whose OEM [code page](http://en.wikipedia.org/wiki/code_page \"wikipedia:code page\") is anything *other* than [437](http://en.wikipedia.org/wiki/code_page_437 \"wikipedia:code page 437\") or [850](http://en.wikipedia.org/wiki/code_page_850 \"wikipedia:code page 850\"). Basically this means any East European language, whether it uses Greek, Cyrillic or Latin writing.\n\nNo API other than WriteConsoleOutputCharacterA is known to be affected. In particular, the Unicode variant WriteConsoleOutputCharacterW works correctly.\n\n### Windows 10\n\nThe Windows terminal program changed in Windows 10. The changed fixed the original W343-3 problem, but certain characters on the [Rogue level](/wiki/Rogue_level \"Rogue level\") may not display correctly. Specifically, the characters that have code points less than 0x20 display as empty boxes. See [IBMgraphics](/wiki/IBMgraphics \"IBMgraphics\") for more details.\n\nThis bug appears when the terminal program is *not* in legacy mode and when a TrueType font is selected.\n\nThis bug is only loosely related to W343-3, but the fix in the code is the same. All users of Windows 10 running NetHack 3.4.3, regardless of locale, can benefit from the W343-3 patch.\n\n## Versions affected\n\n[NetHack 3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\") is known to have this bug. Because [NetHack 3.1.1](/wiki/NetHack_3.1.1 \"NetHack 3.1.1\") through [3.1.3](/wiki/NetHack_3.1.3 \"NetHack 3.1.3\") also use the flawed API, it is likely that they have it as well. [NetHack 3.2.0](/wiki/NetHack_3.2.0 \"NetHack 3.2.0\") through [3.4.2](/wiki/NetHack_3.4.2 \"NetHack 3.4.2\") use different APIs, and do not have this bug.\n\nThe [Curses interface](/wiki/Curses_interface \"Curses interface\") is not affected, even when linked with PDCurses for the Win32 console, because PDCurses does not uses the offending API.\n\n## Patch\n\nThe bug is fixed in [NetHack 3.6.0](/wiki/NetHack_3.6.0 \"NetHack 3.6.0\"). A [patch](/wiki/Patch \"Patch\") is available to fix this bug in [NetHack 3.4.3](/wiki/NetHack_3.4.3 \"NetHack 3.4.3\"); but no binaries or variants other than [Spanish NetHack](/index.php?title=Spanish_NetHack\\&action=edit\\&redlink=1 \"Spanish NetHack (page does not exist)\") are known to incorporate it.\n\nThe patch fixes the API issue by detecting when it is running on an NT-based version of Windows, and using the Unicode API instead, avoiding the Windows bug. It fixes the character set issue as well (see [IBMgraphics](/wiki/IBMgraphics \"IBMgraphics\")) by allowing less-extensive variants of IBMgraphics to be set, avoiding the characters that can vary among code pages.\n\nThe patch was posted to [rec.games.roguelike.nethack](/wiki/Rec.games.roguelike.nethack \"Rec.games.roguelike.nethack\") as four articles:\n\n- [Part 1](http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/65e249e2c8e48115) describes the API issue and provides detailed instructions to duplicate it, and a small test program to demonstrate the bug.\n- [Part 2](http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/2c4e9391e6da19bc) describes the character set issue.\n- [Part 3](http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/1634242b9cc429e2) contains the patch itself.\n- [Part 4](http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/8abe3cd0e85e5a09) is a description of each change the patch makes.\n\nThe [NetHack Patch Database](/wiki/NetHack_Patch_Database \"NetHack Patch Database\") has a simpler form of this patch, that works around the faulty API but does not alter the IBMgraphics, [here](http://nhpatchdb.alt.org/?313). This patch also fixes [W343-4](/wiki/W343-4 \"W343-4\").\n\n[![This article is unlikely to require revision for the next version of NetHack. Click here for more information.](/images/5/58/Noversion.png)](/wiki/NetHackWiki:Next_version \"This article is unlikely to require revision for the next version of NetHack. Click here for more information.\")\n","html":"<!DOCTYPE html>\n<html class=\"client-nojs\" lang=\"en\" dir=\"ltr\">\n<head>\n<meta charset=\"UTF-8\"/>\n<title>W343-3 - NetHack Wiki</title>\n<script>document.documentElement.className = document.documentElement.className.replace( /(^|\\s)client-nojs(\\s|$)/, \"$1client-js$2\" );</script>\n<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({\"wgCanonicalNamespace\":\"\",\"wgCanonicalSpecialPageName\":false,\"wgNamespaceNumber\":0,\"wgPageName\":\"W343-3\",\"wgTitle\":\"W343-3\",\"wgCurRevisionId\":159059,\"wgRevisionId\":159059,\"wgArticleId\":4350,\"wgIsArticle\":true,\"wgIsRedirect\":false,\"wgAction\":\"view\",\"wgUserName\":null,\"wgUserGroups\":[\"*\"],\"wgCategories\":[\"Bugs\"],\"wgBreakFrames\":false,\"wgPageContentLanguage\":\"en\",\"wgPageContentModel\":\"wikitext\",\"wgSeparatorTransformTable\":[\"\",\"\"],\"wgDigitTransformTable\":[\"\",\"\"],\"wgDefaultDateFormat\":\"dmy\",\"wgMonthNames\":[\"\",\"January\",\"February\",\"March\",\"April\",\"May\",\"June\",\"July\",\"August\",\"September\",\"October\",\"November\",\"December\"],\"wgMonthNamesShort\":[\"\",\"Jan\",\"Feb\",\"Mar\",\"Apr\",\"May\",\"Jun\",\"Jul\",\"Aug\",\"Sep\",\"Oct\",\"Nov\",\"Dec\"],\"wgRelevantPageName\":\"W343-3\",\"wgRelevantArticleId\":4350,\"wgRequestId\":\"d95c538e039597b218291f62\",\"wgCSPNonce\":false,\"wgIsProbablyEditable\":false,\"wgRelevantPageIsProbablyEditable\":false,\"wgRestrictionEdit\":[],\"wgRestrictionMove\":[],\"wgWikiEditorEnabledModules\":[],\"wgCategoryTreePageCategoryOptions\":\"{\\\"mode\\\":0,\\\"hideprefix\\\":20,\\\"showcount\\\":true,\\\"namespaces\\\":false}\"});mw.loader.state({\"site.styles\":\"ready\",\"noscript\":\"ready\",\"user.styles\":\"ready\",\"user\":\"ready\",\"user.options\":\"ready\",\"user.tokens\":\"loading\",\"mediawiki.legacy.shared\":\"ready\",\"mediawiki.legacy.commonPrint\":\"ready\",\"mediawiki.toc.styles\":\"ready\",\"mediawiki.skinning.interface\":\"ready\",\"skins.vector.styles\":\"ready\"});mw.loader.implement(\"user.tokens@0tffind\",function($,jQuery,require,module){/*@nomin*/mw.user.tokens.set({\"editToken\":\"+\\\\\",\"patrolToken\":\"+\\\\\",\"watchToken\":\"+\\\\\",\"csrfToken\":\"+\\\\\"});\n});RLPAGEMODULES=[\"site\",\"mediawiki.page.startup\",\"mediawiki.user\",\"mediawiki.page.ready\",\"mediawiki.toc\",\"mediawiki.searchSuggest\",\"skins.vector.js\"];mw.loader.load(RLPAGEMODULES);});</script>\n<link rel=\"stylesheet\" href=\"/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.skinning.interface%7Cmediawiki.toc.styles%7Cskins.vector.styles&amp;only=styles&amp;skin=vector\"/>\n<script async=\"\" src=\"/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector\"></script>\n<meta name=\"ResourceLoaderDynamicStyles\" content=\"\"/>\n<link rel=\"stylesheet\" href=\"/load.php?debug=false&amp;lang=en&amp;modules=site.styles&amp;only=styles&amp;skin=vector\"/>\n<meta name=\"generator\" content=\"MediaWiki 1.32.5\"/>\n<meta name=\"description\" content=\"The bug has been reported on Polish and Russian editions of Windows 2000 and on a Czech version of Windows XP.  It has been duplicated on an American Windows XP by changing a language setting.  A screenshot is available.\"/>\n<link rel=\"image_src\" href=\"/images/6/65/Nethackwiki-logo.png\"/>\n<link rel=\"shortcut icon\" href=\"/images/6/64/Favicon.ico\"/>\n<link rel=\"search\" type=\"application/opensearchdescription+xml\" href=\"/opensearch_desc.php\" title=\"NetHackWiki\"/>\n<link rel=\"EditURI\" type=\"application/rsd+xml\" href=\"https://nethackwiki.com/api.php?action=rsd\"/>\n<link rel=\"canonical\" href=\"/wiki/W343-3\"/>\n<!--[if lt IE 9]><script src=\"/load.php?debug=false&amp;lang=en&amp;modules=html5shiv&amp;only=scripts&amp;skin=vector&amp;sync=1\"></script><![endif]-->\n</head>\n<body class=\"mediawiki ltr sitedir-ltr mw-hide-empty-elt ns-0 ns-subject page-W343-3 rootpage-W343-3 skin-vector action-view\">\t\t<div id=\"mw-page-base\" class=\"noprint\"></div>\n\t\t<div id=\"mw-head-base\" class=\"noprint\"></div>\n\t\t<div id=\"content\" class=\"mw-body\" role=\"main\">\n\t\t\t<a id=\"top\"></a>\n\t\t\t<div class=\"mw-indicators mw-body-content\">\n</div>\n<h1 id=\"firstHeading\" class=\"firstHeading\" lang=\"en\">W343-3</h1>\t\t\t<div id=\"bodyContent\" class=\"mw-body-content\">\n\t\t\t\t<div id=\"siteSub\" class=\"noprint\">From NetHackWiki</div>\t\t\t\t<div id=\"contentSub\"></div>\n\t\t\t\t<div id=\"jump-to-nav\"></div>\t\t\t\t<a class=\"mw-jump-link\" href=\"#mw-head\">Jump to navigation</a>\n\t\t\t\t<a class=\"mw-jump-link\" href=\"#p-search\">Jump to search</a>\n\t\t\t\t<div id=\"mw-content-text\" lang=\"en\" dir=\"ltr\" class=\"mw-content-ltr\"><div class=\"mw-parser-output\"><table style=\"width:100%\">\n\n<tbody><tr valign=\"top\">\n<td><b>W343-3</b> designates a <a href=\"/wiki/Bugs_in_NetHack_3.4.3#W343-3\" title=\"Bugs in NetHack 3.4.3\">bug</a> that affects the <a href=\"/wiki/Microsoft_Windows\" title=\"Microsoft Windows\">Microsoft Windows</a> version of <a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">NetHack 3.4.3</a>.  It is fixed in <a href=\"/wiki/NetHack_3.6.0\" title=\"NetHack 3.6.0\">NetHack 3.6.0</a>.  The bug is listed as:\n<div style=\"border: 1px dashed #2f6fab;background-color: #f9f9f9; padding:0.5em\" class=\"poem\">\n<p><tt>Under the Polish version of Windows 2000 SP4, screen output with a raster font shows wrong characters for many dungeon features</tt>\n</p>\n</div>\n<div id=\"toc\" class=\"toc\"><input type=\"checkbox\" role=\"button\" id=\"toctogglecheckbox\" class=\"toctogglecheckbox\" style=\"display:none\" /><div class=\"toctitle\" lang=\"en\" dir=\"ltr\"><h2>Contents</h2><span class=\"toctogglespan\"><label class=\"toctogglelabel\" for=\"toctogglecheckbox\"></label></span></div>\n<ul>\n<li class=\"toclevel-1 tocsection-1\"><a href=\"#Nature_of_the_bug\"><span class=\"tocnumber\">1</span> <span class=\"toctext\">Nature of the bug</span></a></li>\n<li class=\"toclevel-1 tocsection-2\"><a href=\"#Cause_of_the_bug\"><span class=\"tocnumber\">2</span> <span class=\"toctext\">Cause of the bug</span></a>\n<ul>\n<li class=\"toclevel-2 tocsection-3\"><a href=\"#Windows_10\"><span class=\"tocnumber\">2.1</span> <span class=\"toctext\">Windows 10</span></a></li>\n</ul>\n</li>\n<li class=\"toclevel-1 tocsection-4\"><a href=\"#Versions_affected\"><span class=\"tocnumber\">3</span> <span class=\"toctext\">Versions affected</span></a></li>\n<li class=\"toclevel-1 tocsection-5\"><a href=\"#Patch\"><span class=\"tocnumber\">4</span> <span class=\"toctext\">Patch</span></a></li>\n</ul>\n</div>\n\n</td>\n<td><div class=\"thumb tright\">\n<table class=\"prettytable\" style=\"margin:0\">\n<tbody><tr>\n<th colspan=\"2\"><b>Win32 locales fix</b>\n</th></tr>\n<tr>\n<th>Author\n</th>\n<td>Ray Chason\n</td></tr>\n<tr>\n<th>Download\n</th>\n<td><a class=\"external text\" href=\"http://nhpatchdb.alt.org/?download=313\">link</a>\n</td></tr>\n<tr>\n<th><a href=\"/wiki/NetHack_Patch_Database\" title=\"NetHack Patch Database\">NetHack PatchDB</a>\n</th>\n<td style=\"background-color: #ccffcc;\"><a class=\"external text\" href=\"http://nhpatchdb.alt.org/?313\">313</a>\n</td></tr></tbody></table>\n</div>\n</td></tr></tbody></table>\n<h2><span class=\"mw-headline\" id=\"Nature_of_the_bug\">Nature of the bug</span></h2>\n<p>The bug has been reported on <a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/4ba778741135464e\">Polish</a> and Russian editions of Windows 2000 and on a <a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/8eea5ab560b85b7b\">Czech</a> version of Windows XP.  It has been <a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/6bd4af64d16878f6\">duplicated</a> on an American Windows XP by changing a language setting.  A <a class=\"external text\" href=\"http://amiro.republika.pl/nethack/screen1.png\">screenshot</a> is available.\n</p><p>Bug W343-3 really comprises two distinct and unrelated bugs.  One is a simple character set issue:  many non-USA PCs are configured with different character sets, and seven symbols may look different.  This issue is more fully detailed in the <a href=\"/wiki/IBMgraphics\" title=\"IBMgraphics\">IBMgraphics</a> article.\n</p><p>The more serious bug is that some characters appear as strange symbols or blank squares.  This is not actually a bug in NetHack, but in Windows.  The rest of this article will deal with this bug.\n</p>\n<h2><span class=\"mw-headline\" id=\"Cause_of_the_bug\">Cause of the bug</span></h2>\n<p>The bug is a flaw in the Windows WriteConsoleOutputCharacterA API.  When its configured code page is other than 437 or 850, many non-<a href=\"/wiki/ASCII\" class=\"mw-redirect\" title=\"ASCII\">ASCII</a> characters can show up incorrectly.\n</p><p>The bug occurs when four conditions are met:\n</p>\n<ul><li>The version of Windows is Windows NT or one of its descendants, no later than Windows 8.1.  The bug is confirmed to exist on Windows 2000, Windows XP, Windows Vista, Windows 7, Windows 8 and Windows 8.1. It is confirmed to be fixed on Windows 10 (but see the note below on Windows 10).</li>\n<li>The built-in command shell window is used. Alternate command shell windows are available; <a class=\"external text\" href=\"http://cmder.net/\">Cmder</a>, in particular, is confirmed <i>not</i> to have the bug.</li>\n<li>A bitmap font, rather than Lucida Console, is selected.</li>\n<li>The command shell is running in a window, rather than full screen.  Windows Vista and later do not support full screen mode in the console, and so this item will always be true for those versions of Windows.</li>\n<li>The language for non-Unicode programs is set to one whose OEM <a href=\"http://en.wikipedia.org/wiki/code_page\" class=\"extiw\" title=\"wikipedia:code page\">code page</a> is anything <i>other</i> than <a href=\"http://en.wikipedia.org/wiki/code_page_437\" class=\"extiw\" title=\"wikipedia:code page 437\">437</a> or  <a href=\"http://en.wikipedia.org/wiki/code_page_850\" class=\"extiw\" title=\"wikipedia:code page 850\">850</a>.  Basically this means any East European language, whether it uses Greek, Cyrillic or Latin writing.</li></ul>\n<p>No API other than WriteConsoleOutputCharacterA is known to be affected.  In particular, the Unicode variant WriteConsoleOutputCharacterW works correctly.\n</p>\n<h3><span class=\"mw-headline\" id=\"Windows_10\">Windows 10</span></h3>\n<p>The Windows terminal program changed in Windows 10. The changed fixed the original W343-3 problem, but certain characters on the <a href=\"/wiki/Rogue_level\" title=\"Rogue level\">Rogue level</a> may not display correctly. Specifically, the characters that have code points less than 0x20 display as empty boxes. See <a href=\"/wiki/IBMgraphics\" title=\"IBMgraphics\">IBMgraphics</a> for more details.\n</p><p>This bug appears when the terminal program is <i>not</i> in legacy mode and when a TrueType font is selected.\n</p><p>This bug is only loosely related to W343-3, but the fix in the code is the same. All users of Windows 10 running NetHack 3.4.3, regardless of locale, can benefit from the W343-3 patch.\n</p>\n<h2><span class=\"mw-headline\" id=\"Versions_affected\">Versions affected</span></h2>\n<p><a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">NetHack 3.4.3</a> is known to have this bug.  Because <a href=\"/wiki/NetHack_3.1.1\" title=\"NetHack 3.1.1\">NetHack 3.1.1</a> through <a href=\"/wiki/NetHack_3.1.3\" title=\"NetHack 3.1.3\">3.1.3</a> also use the flawed API, it is likely that they have it as well.  <a href=\"/wiki/NetHack_3.2.0\" title=\"NetHack 3.2.0\">NetHack 3.2.0</a> through <a href=\"/wiki/NetHack_3.4.2\" title=\"NetHack 3.4.2\">3.4.2</a> use different APIs, and do not have this bug.\n</p><p>The <a href=\"/wiki/Curses_interface\" title=\"Curses interface\">Curses interface</a> is not affected, even when linked with PDCurses for the Win32 console, because PDCurses does not uses the offending API.\n</p>\n<h2><span class=\"mw-headline\" id=\"Patch\">Patch</span></h2>\n<p>The bug is fixed in <a href=\"/wiki/NetHack_3.6.0\" title=\"NetHack 3.6.0\">NetHack 3.6.0</a>. A <a href=\"/wiki/Patch\" title=\"Patch\">patch</a> is available to fix this bug in <a href=\"/wiki/NetHack_3.4.3\" title=\"NetHack 3.4.3\">NetHack 3.4.3</a>; but no binaries or variants other than <a href=\"/index.php?title=Spanish_NetHack&amp;action=edit&amp;redlink=1\" class=\"new\" title=\"Spanish NetHack (page does not exist)\">Spanish NetHack</a> are known to incorporate it.\n</p><p>The patch fixes the API issue by detecting when it is running on an NT-based version of Windows, and using the Unicode API instead, avoiding the Windows bug.  It fixes the character set issue as well (see <a href=\"/wiki/IBMgraphics\" title=\"IBMgraphics\">IBMgraphics</a>) by allowing less-extensive variants of IBMgraphics to be set, avoiding the characters that can vary among code pages.\n</p><p>The patch was posted to <a href=\"/wiki/Rec.games.roguelike.nethack\" title=\"Rec.games.roguelike.nethack\">rec.games.roguelike.nethack</a> as four articles:\n</p>\n<ul><li><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/65e249e2c8e48115\">Part 1</a> describes the API issue and provides detailed instructions to duplicate it, and a small test program to demonstrate the bug.</li>\n<li><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/2c4e9391e6da19bc\">Part 2</a> describes the character set issue.</li>\n<li><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/1634242b9cc429e2\">Part 3</a> contains the patch itself.</li>\n<li><a class=\"external text\" href=\"http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/8abe3cd0e85e5a09\">Part 4</a> is a description of each change the patch makes.</li></ul>\n<p>The <a href=\"/wiki/NetHack_Patch_Database\" title=\"NetHack Patch Database\">NetHack Patch Database</a> has a simpler form of this patch, that works around the faulty API but does not alter the IBMgraphics, <a class=\"external text\" href=\"http://nhpatchdb.alt.org/?313\">here</a>.  This patch also fixes <a href=\"/wiki/W343-4\" title=\"W343-4\">W343-4</a>.\n</p><p><br />\n</p>\n<div style=\"display:none; right:10px; padding-bottom: 17px\" class=\"metadata topicon nopopups\"><div style=\"margin-top: -10px\"><a href=\"/wiki/NetHackWiki:Next_version\" title=\"This article is unlikely to require revision for the next version of NetHack. Click here for more information.\"><img alt=\"This article is unlikely to require revision for the next version of NetHack. Click here for more information.\" src=\"/images/5/58/Noversion.png\" width=\"32\" height=\"32\" /></a></div></div>\n\n<!-- \nNewPP limit report\nCached time: 20240926191217\nCache expiry: 604800\nDynamic content: false\nCPU time usage: 0.016 seconds\nReal time usage: 0.057 seconds\nPreprocessor visited node count: 124/1000000\nPreprocessor generated node count: 611/1000000\nPost‐expand include size: 1673/2097152 bytes\nTemplate argument size: 404/2097152 bytes\nHighest expansion depth: 8/40\nExpensive parser function count: 0/100\nUnstrip recursion depth: 0/20\nUnstrip post‐expand size: 238/5000000 bytes\n-->\n<!--\nTransclusion expansion time report (%,ms,calls,template)\n100.00%   18.526      1 -total\n 73.17%   13.555      1 Template:Noversion\n 36.23%    6.712      1 Template:Version_icon\n 25.75%    4.770      1 Template:Patch\n 15.23%    2.821      1 Template:Top_icon\n-->\n\n<!-- Saved in parser cache with key wikihackdb:pcache:idhash:4350-0!canonical and timestamp 20240926191217 and revision id 159059\n -->\n</div></div>\t\t\t\t\t<div class=\"printfooter\">\n\t\t\t\t\t\tRetrieved from \"<a dir=\"ltr\" href=\"https://nethackwiki.com/index.php?title=W343-3&amp;oldid=159059\">https://nethackwiki.com/index.php?title=W343-3&amp;oldid=159059</a>\"\t\t\t\t\t</div>\n\t\t\t\t<div id=\"catlinks\" class=\"catlinks\" data-mw=\"interface\"><div id=\"mw-normal-catlinks\" class=\"mw-normal-catlinks\"><a href=\"/wiki/Special:Categories\" title=\"Special:Categories\">Category</a>: <ul><li><a href=\"/wiki/Category:Bugs\" title=\"Category:Bugs\">Bugs</a></li></ul></div></div>\t\t\t\t<div class=\"visualClear\"></div>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t<div id=\"mw-navigation\">\n\t\t\t<h2>Navigation menu</h2>\n\t\t\t<div id=\"mw-head\">\n\t\t\t\t\t\t\t\t\t<div id=\"p-personal\" role=\"navigation\" class=\"\" aria-labelledby=\"p-personal-label\">\n\t\t\t\t\t\t<h3 id=\"p-personal-label\">Personal tools</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"pt-createaccount\"><a href=\"/index.php?title=Special:CreateAccount&amp;returnto=W343-3\" title=\"You are encouraged to create an account and log in; however, it is not mandatory\">Create account</a></li><li id=\"pt-login\"><a href=\"/index.php?title=Special:UserLogin&amp;returnto=W343-3\" title=\"You are encouraged to log in; however, it is not mandatory [o]\" accesskey=\"o\">Log in</a></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div id=\"left-navigation\">\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-namespaces\" role=\"navigation\" class=\"vectorTabs\" aria-labelledby=\"p-namespaces-label\">\n\t\t\t\t\t\t<h3 id=\"p-namespaces-label\">Namespaces</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"ca-nstab-main\" class=\"selected\"><span><a href=\"/wiki/W343-3\" title=\"View the content page [c]\" accesskey=\"c\">Page</a></span></li><li id=\"ca-talk\"><span><a href=\"/wiki/Talk:W343-3\" rel=\"discussion\" title=\"Discussion about the content page [t]\" accesskey=\"t\">Discussion</a></span></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-variants\" role=\"navigation\" class=\"vectorMenu emptyPortlet\" aria-labelledby=\"p-variants-label\">\n\t\t\t\t\t\t\t\t\t\t\t\t<input type=\"checkbox\" class=\"vectorMenuCheckbox\" aria-labelledby=\"p-variants-label\" />\n\t\t\t\t\t\t<h3 id=\"p-variants-label\">\n\t\t\t\t\t\t\t<span>Variants</span>\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<div class=\"menu\">\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t<div id=\"right-navigation\">\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-views\" role=\"navigation\" class=\"vectorTabs\" aria-labelledby=\"p-views-label\">\n\t\t\t\t\t\t<h3 id=\"p-views-label\">Views</h3>\n\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t<li id=\"ca-view\" class=\"collapsible selected\"><span><a href=\"/wiki/W343-3\">Read</a></span></li><li id=\"ca-viewsource\" class=\"collapsible\"><span><a href=\"/index.php?title=W343-3&amp;action=edit\" title=\"This page is protected.&#10;You can view its source [e]\" accesskey=\"e\">View source</a></span></li><li id=\"ca-history\" class=\"collapsible\"><span><a href=\"/index.php?title=W343-3&amp;action=history\" title=\"Past revisions of this page [h]\" accesskey=\"h\">View history</a></span></li>\t\t\t\t\t\t</ul>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-cactions\" role=\"navigation\" class=\"vectorMenu emptyPortlet\" aria-labelledby=\"p-cactions-label\">\n\t\t\t\t\t\t<input type=\"checkbox\" class=\"vectorMenuCheckbox\" aria-labelledby=\"p-cactions-label\" />\n\t\t\t\t\t\t<h3 id=\"p-cactions-label\"><span>More</span></h3>\n\t\t\t\t\t\t<div class=\"menu\">\n\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div id=\"p-search\" role=\"search\">\n\t\t\t\t\t\t<h3>\n\t\t\t\t\t\t\t<label for=\"searchInput\">Search</label>\n\t\t\t\t\t\t</h3>\n\t\t\t\t\t\t<form action=\"/index.php\" id=\"searchform\">\n\t\t\t\t\t\t\t<div id=\"simpleSearch\">\n\t\t\t\t\t\t\t\t<input type=\"search\" name=\"search\" placeholder=\"Search NetHackWiki\" title=\"Search NetHackWiki [f]\" accesskey=\"f\" id=\"searchInput\"/><input type=\"hidden\" value=\"Special:Search\" name=\"title\"/><input type=\"submit\" name=\"fulltext\" value=\"Search\" title=\"Search the pages for this text\" id=\"mw-searchButton\" class=\"searchButton mw-fallbackSearchButton\"/><input type=\"submit\" name=\"go\" value=\"Go\" title=\"Go to a page with this exact name if it exists\" id=\"searchButton\" class=\"searchButton\"/>\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</form>\n\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div id=\"mw-panel\">\n\t\t\t\t<div id=\"p-logo\" role=\"banner\"><a class=\"mw-wiki-logo\" href=\"/wiki/Main_Page\"  title=\"Visit the main page\"></a></div>\n\t\t\t\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-navigation\" aria-labelledby=\"p-navigation-label\">\n\t\t\t<h3 id=\"p-navigation-label\">Navigation</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-NetHack-Wiki\"><a href=\"/wiki/Main_Page\">NetHack Wiki</a></li><li id=\"n-Forum\"><a href=\"/wiki/Forum:Watercooler\">Forum</a></li><li id=\"n-portal\"><a href=\"/wiki/NetHackWiki:Community_Portal\" title=\"About the project, what you can do, where to find things\">Community portal</a></li><li id=\"n-recentchanges\"><a href=\"/wiki/Special:RecentChanges\" title=\"A list of recent changes in the wiki [r]\" accesskey=\"r\">Recent changes</a></li><li id=\"n-randompage\"><a href=\"/wiki/Special:Random\" title=\"Load a random page [x]\" accesskey=\"x\">Random page</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-Popular_pages\" aria-labelledby=\"p-Popular_pages-label\">\n\t\t\t<h3 id=\"p-Popular_pages-label\">Popular pages</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-Dungeon-features\"><a href=\"/wiki/Dungeon_feature\">Dungeon features</a></li><li id=\"n-Monsters\"><a href=\"/wiki/Monster#Canonical_list_of_monsters\">Monsters</a></li><li id=\"n-In.2FExtrinsics\"><a href=\"/wiki/Property#Intrinsic_properties\">In/Extrinsics</a></li><li id=\"n-Items\"><a href=\"/wiki/Item\">Items</a></li><li id=\"n-Spells\"><a href=\"/wiki/Spellbook#List_of_spellbooks\">Spells</a></li><li id=\"n-Game-options\"><a href=\"/wiki/Options\">Game options</a></li><li id=\"n-Websites\"><a href=\"/wiki/Websites\">Websites</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-contributing\" aria-labelledby=\"p-contributing-label\">\n\t\t\t<h3 id=\"p-contributing-label\">Contributing</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"n-Style-guide\"><a href=\"/wiki/NetHackWiki:Style_guide\">Style guide</a></li><li id=\"n-help\"><a href=\"/wiki/NetHackWiki:How_to_help\" title=\"The place to find out\">How to help</a></li><li id=\"n-Current-projects\"><a href=\"/wiki/NetHackWiki:Current_projects\">Current projects</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t<div class=\"portal\" role=\"navigation\" id=\"p-tb\" aria-labelledby=\"p-tb-label\">\n\t\t\t<h3 id=\"p-tb-label\">Tools</h3>\n\t\t\t<div class=\"body\">\n\t\t\t\t\t\t\t\t<ul>\n\t\t\t\t\t<li id=\"t-whatlinkshere\"><a href=\"/wiki/Special:WhatLinksHere/W343-3\" title=\"A list of all wiki pages that link here [j]\" accesskey=\"j\">What links here</a></li><li id=\"t-recentchangeslinked\"><a href=\"/wiki/Special:RecentChangesLinked/W343-3\" rel=\"nofollow\" title=\"Recent changes in pages linked from this page [k]\" accesskey=\"k\">Related changes</a></li><li id=\"t-specialpages\"><a href=\"/wiki/Special:SpecialPages\" title=\"A list of all special pages [q]\" accesskey=\"q\">Special pages</a></li><li id=\"t-print\"><a href=\"/index.php?title=W343-3&amp;printable=yes\" rel=\"alternate\" title=\"Printable version of this page [p]\" accesskey=\"p\">Printable version</a></li><li id=\"t-permalink\"><a href=\"/index.php?title=W343-3&amp;oldid=159059\" title=\"Permanent link to this revision of the page\">Permanent link</a></li><li id=\"t-info\"><a href=\"/index.php?title=W343-3&amp;action=info\" title=\"More information about this page\">Page information</a></li>\t\t\t\t</ul>\n\t\t\t\t\t\t\t</div>\n\t\t</div>\n\t\t\t\t</div>\n\t\t</div>\n\t\t\t\t<div id=\"footer\" role=\"contentinfo\">\n\t\t\t\t\t\t<ul id=\"footer-info\">\n\t\t\t\t\t\t\t\t<li id=\"footer-info-lastmod\"> This page was last edited on 21 December 2023, at 01:36.</li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t<ul id=\"footer-places\">\n\t\t\t\t\t\t\t\t<li id=\"footer-places-about\"><a href=\"/wiki/NetHackWiki:About\" title=\"NetHackWiki:About\">About NetHackWiki</a></li>\n\t\t\t\t\t\t\t\t<li id=\"footer-places-disclaimer\"><a href=\"/wiki/NetHackWiki:General_disclaimer\" title=\"NetHackWiki:General disclaimer\">Disclaimers</a></li>\n\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t\t\t\t\t<ul id=\"footer-icons\" class=\"noprint\">\n\t\t\t\t\t\t\t\t\t\t<li id=\"footer-poweredbyico\">\n\t\t\t\t\t\t<a href=\"//www.mediawiki.org/\"><img src=\"/resources/assets/poweredby_mediawiki_88x31.png\" alt=\"Powered by MediaWiki\" srcset=\"/resources/assets/poweredby_mediawiki_132x47.png 1.5x, /resources/assets/poweredby_mediawiki_176x62.png 2x\" width=\"88\" height=\"31\"/></a>\t\t\t\t\t</li>\n\t\t\t\t\t\t\t\t\t</ul>\n\t\t\t\t\t\t<div style=\"clear: both;\"></div>\n\t\t</div>\n\t\t\n<script>(window.RLQ=window.RLQ||[]).push(function(){mw.config.set({\"wgPageParseReport\":{\"limitreport\":{\"cputime\":\"0.016\",\"walltime\":\"0.057\",\"ppvisitednodes\":{\"value\":124,\"limit\":1000000},\"ppgeneratednodes\":{\"value\":611,\"limit\":1000000},\"postexpandincludesize\":{\"value\":1673,\"limit\":2097152},\"templateargumentsize\":{\"value\":404,\"limit\":2097152},\"expansiondepth\":{\"value\":8,\"limit\":40},\"expensivefunctioncount\":{\"value\":0,\"limit\":100},\"unstrip-depth\":{\"value\":0,\"limit\":20},\"unstrip-size\":{\"value\":238,\"limit\":5000000},\"timingprofile\":[\"100.00%   18.526      1 -total\",\" 73.17%   13.555      1 Template:Noversion\",\" 36.23%    6.712      1 Template:Version_icon\",\" 25.75%    4.770      1 Template:Patch\",\" 15.23%    2.821      1 Template:Top_icon\"]},\"cachereport\":{\"timestamp\":\"20240926191217\",\"ttl\":604800,\"transientcontent\":false}}});mw.config.set({\"wgBackendResponseTime\":153});});</script>\n\t</body>\n</html>\n","rawPage":"{|style=\"width:100%\"\n|-valign=\"top\"\n|'''W343-3''' designates a [[bugs in NetHack 3.4.3#W343-3|bug]] that affects the [[Microsoft Windows]] version of [[NetHack 3.4.3]].  It is fixed in [[NetHack 3.6.0]].  The bug is listed as:\n\n<poem style=\"border: 1px dashed #2f6fab;background-color: #f9f9f9; padding:0.5em\">\n<tt>Under the Polish version of Windows 2000 SP4, screen output with a raster font shows wrong characters for many dungeon features</tt></poem>\n\n__TOC__\n|{{patch\n |name=Win32 locales fix\n |author=Ray Chason\n |download=http://nhpatchdb.alt.org/?download=313\n |bilious=313\n}}\n|}\n\n== Nature of the bug ==\n\nThe bug has been reported on [http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/4ba778741135464e Polish] and Russian editions of Windows 2000 and on a [http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/8eea5ab560b85b7b Czech] version of Windows XP.  It has been [http://groups.google.com/group/rec.games.roguelike.nethack/browse_frm/thread/6bd4af64d16878f6 duplicated] on an American Windows XP by changing a language setting.  A [http://amiro.republika.pl/nethack/screen1.png screenshot] is available.\n\nBug W343-3 really comprises two distinct and unrelated bugs.  One is a simple character set issue:  many non-USA PCs are configured with different character sets, and seven symbols may look different.  This issue is more fully detailed in the [[IBMgraphics]] article.\n\nThe more serious bug is that some characters appear as strange symbols or blank squares.  This is not actually a bug in NetHack, but in Windows.  The rest of this article will deal with this bug.\n\n== Cause of the bug ==\n\nThe bug is a flaw in the Windows WriteConsoleOutputCharacterA API.  When its configured code page is other than 437 or 850, many non-[[ASCII]] characters can show up incorrectly.\n\nThe bug occurs when four conditions are met:\n\n* The version of Windows is Windows NT or one of its descendants, no later than Windows 8.1.  The bug is confirmed to exist on Windows 2000, Windows XP, Windows Vista, Windows 7, Windows 8 and Windows 8.1. It is confirmed to be fixed on Windows 10 (but see the note below on Windows 10).\n* The built-in command shell window is used. Alternate command shell windows are available; [http://cmder.net/ Cmder], in particular, is confirmed ''not'' to have the bug.\n* A bitmap font, rather than Lucida Console, is selected.\n* The command shell is running in a window, rather than full screen.  Windows Vista and later do not support full screen mode in the console, and so this item will always be true for those versions of Windows.\n* The language for non-Unicode programs is set to one whose OEM [[wikipedia:code page|code page]] is anything ''other'' than [[wikipedia:code page 437|437]] or  [[wikipedia:code page 850|850]].  Basically this means any East European language, whether it uses Greek, Cyrillic or Latin writing.\n\nNo API other than WriteConsoleOutputCharacterA is known to be affected.  In particular, the Unicode variant WriteConsoleOutputCharacterW works correctly.\n\n=== Windows 10 ===\n\nThe Windows terminal program changed in Windows 10. The changed fixed the original W343-3 problem, but certain characters on the [[Rogue level]] may not display correctly. Specifically, the characters that have code points less than 0x20 display as empty boxes. See [[IBMgraphics]] for more details.\n\nThis bug appears when the terminal program is ''not'' in legacy mode and when a TrueType font is selected.\n\nThis bug is only loosely related to W343-3, but the fix in the code is the same. All users of Windows 10 running NetHack 3.4.3, regardless of locale, can benefit from the W343-3 patch.\n\n== Versions affected ==\n\n[[NetHack 3.4.3]] is known to have this bug.  Because [[NetHack 3.1.1]] through [[NetHack 3.1.3|3.1.3]] also use the flawed API, it is likely that they have it as well.  [[NetHack 3.2.0]] through [[NetHack 3.4.2|3.4.2]] use different APIs, and do not have this bug.\n\nThe [[Curses interface]] is not affected, even when linked with PDCurses for the Win32 console, because PDCurses does not uses the offending API.\n\n== Patch ==\n\nThe bug is fixed in [[NetHack 3.6.0]]. A [[patch]] is available to fix this bug in [[NetHack 3.4.3]]; but no binaries or variants other than [[Spanish NetHack]] are known to incorporate it.\n\nThe patch fixes the API issue by detecting when it is running on an NT-based version of Windows, and using the Unicode API instead, avoiding the Windows bug.  It fixes the character set issue as well (see [[IBMgraphics]]) by allowing less-extensive variants of IBMgraphics to be set, avoiding the characters that can vary among code pages.\n\nThe patch was posted to [[rec.games.roguelike.nethack]] as four articles:\n\n* [http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/65e249e2c8e48115 Part 1] describes the API issue and provides detailed instructions to duplicate it, and a small test program to demonstrate the bug.\n* [http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/2c4e9391e6da19bc Part 2] describes the character set issue.\n* [http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/1634242b9cc429e2 Part 3] contains the patch itself.\n* [http://groups.google.com/group/rec.games.roguelike.nethack/browse_thread/thread/8abe3cd0e85e5a09 Part 4] is a description of each change the patch makes.\n\nThe [[NetHack Patch Database]] has a simpler form of this patch, that works around the faulty API but does not alter the IBMgraphics, [http://nhpatchdb.alt.org/?313 here].  This patch also fixes [[W343-4]].\n\n{{noversion}}<!--historic-->\n[[Category:Bugs]]"}