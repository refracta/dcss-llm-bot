{"title":"Spell Success","url":"http://crawl.chaosforge.org/Spell_Success","type":"raw","data":"{{version031}}\n{| style=\"float: right;\"\n| __TOC__\n|}\n\n'''Spell success''' is the rate at which casting a [[spell]] can be expected to succeed.\nSpell success rate is determined by a complex combination of:\n\n# Spell level\n# Spell-related skills, [[Intelligence]]\n# Penalties from [[body armour]] and [[shields]] (mitigated by [[Armour (skill)|Armour skill]] / [[Shields (skill)|Shields skill]])\n# Modifiers like [[Wizardry]] and [[Good_mutations#Wild_Magic|Wild Magic]]\n\n==Base Chance==\nThe source code talks in terms of chance of ''failure'', not success. Therefore, we want the spellFailure chance to be as low as possible - in fact, to reach a 0% failure rate, your chance to fail has to be '''negative'''. More on that below.\n\nThe base failure before ''any'' modifiers is as follows:<ref>{{source ref|0.30.0|spl-cast.cc|406}}</ref>\n\n  spellFailure = 60\n               - [6 * spell_skills]\n               - [2 * Intelligence]\n               + Spell difficulty\n               + Encumbrance penalties\n\n* 60 is an arbitrary base chance of failure.\n* Increasing intelligence and spell skills (skills respective to the spell ''and'' [[Spellcasting]]) will decrease failure.\n* Higher level spells are more difficult, wearing armour/shields make it more difficult.\n\n=== Spell skills ===\n\"Spell_skills\" takes into account Spellcasting and an average of a spell's schools (e.g. a Conjurations / Fire spell will take the average of the [[Conjurations]] skill and [[Fire Magic]] skill). This is calculated with the following equation:<ref>{{source ref|0.30.0|spl-cast.cc|413}}</ref>\n<ref>{{source ref|0.30.0|spl-cast.cc|377}}</ref>\n  spell_skills = [Spellcasting / 2] + [Average(Skill_level) * 2]\n\n=== Spell difficulty ===\nHigher level spells are more difficult. Each level of spell adds a number to your spell failure rate:<ref>{{source ref|0.30.0|spl-cast.cc|422}}</ref>\n\n  spellDifficulty =   3 (level 1)\n                     15 (level 2)   (+12)\n                     35 (level 3)   (+20)\n                     70 (level 4)   (+35)\n                    100 (level 5)   (+30)\n                    150 (level 6)   (+50)\n                    200 (level 7)   (+50)\n                    260 (level 8)   (+60)\n                    340 (level 9)   (+80)\n\n=== Encumbrance penalties ===\n\nBoth Armour and Shield penalties for spells are derived from their [[EV]] penalties. First, calculate the ev penalty, then calculate the spell penalty. Armour and Shields do not influence each other.\n\n'''Armour'''<ref>{{source ref|0.30.0|player.cc|5723}}</ref><ref>{{source ref|0.30.0|player.cc|2131}}</ref>\n\n  ev penalty = 1/225 * [[encumbrance]]^2 * (90 - 2 * [[Armour (skill)|armour_skill]]) / ([[str]] + 3)\n  spell penalty = 19 * ev penalty\n\n'''Shield'''<ref>{{source ref|0.30.0|player.cc|5739}}</ref><ref>{{source ref|0.30.0|player.cc|2134}}</ref>\n\n  ev penalty = 2/5 * [[Shields#EV_Penalty|encumbrance]]^2 / (5 + str) * (27 - [[Shields_(skill)|shield_skill]]) / 27\n  spell penalty = 19 * ev penalty\n\n== Step down ==\nAt this point, the spell failure is put through a complicated post-processing curve:<ref>{{source ref|0.30.0|spl-cast.cc|463}}</ref>\n\n (x^3 + 426x^2 + 82670x + 6983254) / 262144 IF spellFailure < 43\n\nThis replicates a step-down curve:\n[[File:Spell_success_stepdown.png|thumb|center|800px|x-axis = spellFailure, y-axis = Raw Failure Rate]]\n\nThis curve has the following points:\n{| class=\"prettytable\" style=\"text-align: center\" border=1\n|-\n!SpellFailure!!Raw fail chance\n|-\n|43 || 43%\n|-\n|25 || 36.6%\n|-\n|0 || 27.7%\n|-\n|<nowiki>-</nowiki>50 || 15.5%\n|-\n|<nowiki>-</nowiki>72 || 10%\n|-\n|<nowiki>-</nowiki>100 || 8.5%\n|-\n|<nowiki>-</nowiki>173 || 0% \n|-\n|}\n\n==Modifiers==\nThe following modifiers are added after the STEPPED DOWN failure rates above. However, it is still considered the ''raw spell failure chance'', which is adjusted by a sigmoid function later.<ref>{{source ref|0.30.0|spl-cast.cc|466}}</ref>\n\n'''Positive (+spell failure):'''\n*[[Wild Magic (mutation)|Wild Magic]]: +4% per level\n*Disrupted Magic (-Wiz) [[Ru|sacrifice]]: +4% per level\n*[[Orb]] of [[energy]]: +10%\n**[[Crystal ball of Wucad Mu]]: +10%\n*[[Vertigo]]: +7%\n\n'''Negative (-spell failure):'''\n*[[Subdued Magic]]: -2% per level\n*[[Wizardry]]: multiplied by ×<code>6 / (7 + sources)</code>%, assuming you have at least one source. (×75% for Wiz x1, ×66.6% for Wiz x2, and so on.)\n*[[Vehumet]]: multiplied by ×66.6%.<ref>{{source ref|0.30.0|spl-cast.cc|335}}</ref> (Note: this is not considered a source of wizardry, but it multiplicatively stacks with wizardry.)\n\nThe wizardry and Vehumet multipliers are applied after all others.<ref>{{source ref|0.30.0|spl-cast.cc|475}}</ref>\n\nAfter all modifiers have applied, you will get a cumulative ''raw spell failure chance''. This is converted into the final success via the function below.\n\n==Final Step==\nIn short, the game doesn't compare your raw failure chance with a number from 0 to 99. Instead, it compares the raw failure to the sum of three numbers divided by three.<ref>{{source ref|0.30.0|spl-cast.cc|2533}}</ref>\n (1d101 + 1d101 + 1d100 - 3)/3 < fail chance\n\nThis is equivalent to applying this transformation to the chance of failure:\n\n[[Image:Spell_success_transformation.png]]\n\nThis sigmoid function makes it more difficult to decrease your failure rate when it is high or low, but it will go down very quickly when it is in the middle. For raw failures below 33%, one can use this formula:\n\n  N                 = (raw_failure_rate) * 3\n  Real Failure Rate = N * (N+1) * (N+2) / 6 / 101 / 101 (in unit of %)\n\nThis can be tabulated for usefulness.\n\n{| class=\"prettytable\" style=\"text-align: center\" border=1\n|-\n!SpellFailure Req'd*!!Raw fail chance!!Actual fail chance\n|-\n|13||32%||14.9%\n|-\n|7||30%||12.3%\n|-\n|1||28%||10.0%\n|-\n|<nowiki>-</nowiki>6||26%||8.1%\n|-\n|<nowiki>-</nowiki>12||24%||6.4%\n|-\n|<nowiki>-</nowiki>20||22%||4.9%\n|-\n|<nowiki>-</nowiki>28||20%||3.7%\n|-\n|<nowiki>-</nowiki>37||18%||2.7%\n|-\n|<nowiki>-</nowiki>47||16%||1.9%\n|-\n|<nowiki>-</nowiki>58||14%||1.3%\n|-\n|<nowiki>-</nowiki>71||12%||0.8%\n|-\n|}\n<nowiki>*</nowiki>SpellFailure required to reach a given raw fail chance, ''assuming you don't have any modifiers like [[wizardry]]''. E.g. if you have wizardry x1, having 1 SpellFailure = (28% * 0.75) raw failure = 21% raw failure.\n\n== Strategy ==\nIt is debatable whether these formulae are of any practical use during a game.\n\nIt may be nice to know a few things from a strategic point of view. \n*High level spells take a massive amount of XP to train, and it can be useful to know how many levels you'd need. \n*You can quantize your level of armour [[encumbrance]]. A caster could say \"a set of [[fire dragon scales]] gives a spell penalty equal to 6 levels of each spell school\". Then, you could determine if wearing FDS is worth it, both short-term (\"can I cast a spell in this ''right now''?\") and long-term (\"can I cast a spell in this ''when I reach Zot''?\").\n*You can calculate the relative value of a skill. For example, you can see when a level of <Spell School> would be more valuable than a level of Armour skill, or when a point of [[strength]] is worth more than a point of [[intelligence]].\n\nOf course, this isn't necessary. You can derive most (if not all) of this information by just checking your spell failure in game. If you wear a pierce of armour, and determine that your spell failure is unacceptable, then don't wear that armour - no need to calculate it! After you trained your skill a bit, you can wear a desired armour again, and see if it's any better.\n\n==Analysis==\n\n===Skill Req'd to Cast L9 Spells===\nSay you wanted to [[Fire Storm]] reliably. For sake of example, we're trying to reach a 10% failure rate. You can look at the table above: to get a 10% actual failure rate, you'd need 28% raw failure. If you have no wizardry, 28% raw failure = 1 SpellFailure.\n\nUsing the [[#Base Chance|SpellFailure]] calculations at the top of the page, you can calculate what's needed to get to 1 SpellFailure. For this example, assume you have 30 intelligence, no wizardry, and 0 encumbrance from armour/shields.\n\n 60 (base failure)\n + 340 (level 9 spell)\n - 6 * [0.5 * spellcasting + 2 * avg_skill] (spell skills)\n - 30 * 2 (30 intelligence)\n + 0 (encumbrance)<br><br>= 340 - (3 * spellcasting) - (12 * avg_skill) = SpellFailure\n\nWe want a SpellFailure = 1, so <code>340 - (3 * spellcasting) - (12 * avg_skill) = 1</code>. So if you had an Spellcasting skill of 14, you'd need 24.75 in avg_skill - that is, Fire Magic and Conjurations. If you had a Spellcasting skill of 22.7, you'd need 22.7 in Fire Magic and Conjurations.\n\nWizardry reduces your raw failure rate by x75% for 1 stack, x66% for 2 stacks, etc.. So if you had wizardry x1, you'd need a (28 / .75) = 37.3% raw failure before wizardry (which, in turn, equals 29.21 SpellFailure). The same calculations can be done for other amounts of wizardry.\n\nSo, assuming you have 30 int and 0 encumbrance, the following skills would reach the desired 10% actual failure rate:\n*'''No Wizardry''': {14 Spellcasting, 24.75 avg_skill}, {22.7 Spellcasting, 22.7 avg_skill}\n*'''Wizardry x1''': {14 Spellcasting, 22.49 avg_skill}, {20.7 Spellcasting, 20.7 avg_skill}\n*'''Wizardry x2''' / '''Vehumet''': {14 Spellcasting, 21.5 avg_skill}, {20 Spellcasting, 20 avg_skill}\n*'''Vehumet + Wizardry x1''': {14 Spellcasting, 20.2 avg_skill}, {18.9 Spellcasting, 18.9 avg_skill}\n\nThese numbers apply to any level 9 spell in the game, not just Fire Storm... again, ''assuming you have 30 int / 0 encumbrance''. If you're wearing [[swamp dragon scales]] and a [[kite shield]], for instance, it'll take more skill to cast. Change the values of spell level, intelligence, encumbrance as you see fit.\n\n===Measuring Encumbrance===\nThe effect of encumbrance on your actual % to fail is non-linear. However, it can be measured by \"levels of a spell school needed to compensate\".\n\n'''Armour'''\n\nBody armour increases SpellFailure by <code>19/225 * encumbrance^2 * (90 - 2 * Armour) / (str + 3)</code>. Having 1 level of every spell school (except Spellcasting) reduces SpellFailure by 12. Therefore, armour encumbrance can be measured in terms of skill levels, using the formula [SpellFailure Increase] / 12.\n\nAs an example: say you have 6 strength, are wearing [[troll leather armour]] (encumbrance = 4), and have 0 Armour skill. Your SpellFailure would be <code>19/225 * 4^2 * (90 - 0) / (6 + 3)</code> = 13.51 SpellFailure, or 1.13 levels in each skill. That really isn't much in the grand scheme of things. By the time you get troll leather armour, you can negate a ~1 level penalty.\n\nFor reference:\n*10 strength, [[leather armour]], 0 Armour skill: -0.78 levels in each skill\n*10 strength, [[ring mail]] or [[swamp dragon scales]], 5 Armour skill:  -2.12 levels in each skill\n*10 strength, [[fire dragon scales]], 5 Armour skill: -5.24 levels in each skill\n\nRemember that things change based on strength and skill. Also remember that you can train Armour skill to lower the penalty (see [[#Armour skill vs Spell skill|Armour skill vs Spell skill]] for more).\n\n'''Shields'''\n\nShield increases SpellFailure by <code>38/5 * encumbrance^2 / (str + 5) * (27 - Shields)/27</code>. Using the same method as body armour, as seen above, you can get a number for shield encumbrance, too. Relative to armour, strength matters a little less, but Shields skill matters more.\n\nIf you have 6 strength, a [[buckler]] (encumbrance = 5), and have 0 Shields skill, SpellFailure equals <code>38/5 * 5^2 / (6 + 5) * 27/27</code> = 17.27, or 1.44 levels in each skill. A [[kite shield]] would be 4x that, a [[tower shield]] would be 9x that.\n\n===Armour skill vs Spell skill===\n*Armour skill reduces SpellFailure by <code>-Armour * 38/225 * encumbrance^2 / (str + 3)</code>.\n*Having 1 of every spell school (except Spellcasting) reduces SpellFailure by 12. Divide by number of spell schools if needed.\n*Therefore, each level in Armour is worth <code>19/1350 * encumbrance^2 / (str + 3)</code>, or roughly <code>1/71 * encumbrance^2 / (str + 3)</code>, levels in each spell school. \n\nFor example, if you have 11 strength and are wearing [[fire dragon scales]], the equation <code>1/71 * 11^2 / 14</code> = 0.122, or 8.21 Armour : 1 in each spell school. If you have a dual-school spell, like [[Fireball]], 4.1 Armour skill = 1 Earth Magic OR 1 Conjurations, while 8.21 Armour = 1 Earth AND Conjurations.\n\nOf course, this '''ONLY''' takes into account spell failure. Training Armour skill increases your defenses; training spell schools increases your power.\n\n===Strength vs Intelligence===\n*For a given change in strength 'x', strength reduces both armour and shield encumbrance by:\n**Armour: <code>(1/<str+3> - 1/<str+x+3>) * 19/225 * encumbrance^2 * (90 - 2 * Armour)</code>\n**Shield: <code>(1/<str+5> - 1/<str+x+5>) * 38/5 * encumbrance^2 * (27 - Shields)/27</code>\n*Intelligence reduces SpellFailure by 2 per point.\n\nSay you have 11 strength, fire dragon scales, and 0 Armour skill. On level up, you have a choice of 2 str or 2 int. The impact of +2 str is equal to <code>(1/14 - 1/16) * 19/225 * 11^2 * (90 - 0)</code> = 8.21 SpellFailure, greater than 2*2 = 4 SpellFailure from intelligence.\n\nIf this 11 strength character is also wearing a [[kite shield]], with 9 Shields skill, +2 strength would also give <code>(1/16 - 1/18) * 38/5 * 10^2 * 18/27</code> = 3.52 SpellFailure.\n\nOf course, intelligence also increases [[spell power]], while strength reduces [[EV]] penalties.\n\n==See also==\n*[[Spell power]]\n*[[Miscast effect]]\n\n==History==\n*Prior to [[0.31]], the raw failure rate multiplier from wizardry/Vehumet was capped at 50%. Therefore, you could only have a maximum of 5 stacks of wizardry, or 1 stack of wizardry with Vehumet's bonus. Also, some [[transmutations]] increased your spell failure: [[Spider Form]] (+10%) and [[Blade Hands (spell)|Blade Hands]] (+20%).\n*Prior to [[0.22]], spell_schools went through a stepdown, <code>50 * log2(1 + spell_schools/50)</code>, which penalized the caster if <code>(Spellcasting/2) + (2* AvgSpellSchool) > 50</code>. However, spellFailure for level 9 spells was 330 instead of 340.\n*Prior to [[0.20]], the [[#Step down|Step down]] function was different, relying on breakpoints rather than a polynomial. Also, more breakpoints existed elsewhere in the spell failure calculation.\n\n==References==\n<references/>\n\n[[Category:Magic]]"}